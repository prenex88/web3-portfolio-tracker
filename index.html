<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 Portfolio Tracker Pro - Cloud Edition</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Verhindert, dass der Browser scrollt, während wir das Bottom Sheet ziehen. */
        .bottom-sheet-header {
            touch-action: none;
        }
    </style>
</head>
<body>

    <div id="biometricOverlay" class="biometric-overlay">
        <div class="biometric-content">
            <div class="biometric-icon">🔐</div>
            <div class="biometric-text">Portfolio Tracker entsperren</div>
            <div class="biometric-subtitle">Verwenden Sie Ihren Fingerabdruck oder Face ID</div>
            <button class="biometric-fallback" onclick="bypassBiometric()">
                Ohne Authentifizierung fortfahren
            </button>
        </div>
    </div>

    <div id="syncStatusBar" class="sync-status-bar">
        <div class="sync-status">
            <div id="syncIndicator" class="sync-indicator offline"></div>
            <span id="syncStatusText">Offline Modus</span>
            <span id="lastSyncTime" style="color: var(--text-secondary); font-size: 12px;"></span>
        </div>
        <div class="sync-actions">
            <button id="syncNowBtn" class="btn btn-primary btn-small" onclick="syncNow()">
                <span id="syncBtnIcon">☁️</span>
                <span id="syncBtnText">Sync</span>
            </button>
            <button class="btn btn-small" onclick="toggleSyncBar()">✕</button>
        </div>
    </div>

    <div class="container" id="appContainer">
        <div class="header">
            <div class="header-content">
                <div class="header-title-group" onclick="switchTab('dashboard')" style="cursor: pointer;" title="Zum Dashboard">
                    <h1>🚀 Web3 Portfolio</h1>
                    <!-- Subtitle nur auf Desktop -->
                    <div class="subtitle desktop-only">Track your crypto & DeFi investments</div>
                </div>
                <!-- Controls nur auf Desktop -->
                <div class="header-controls desktop-only">
                <button id="globalSearchBtn" class="btn-icon" title="Globale Suche (Ctrl+K)">🔍</button>
                <button class="theme-toggle btn-icon" onclick="toggleTheme()" title="Theme wechseln (Ctrl+D)">🌙</button>
                
                <!-- Dropdown Menü -->
                <div class="header-menu-dropdown">
                    <button class="btn-icon" onclick="toggleHeaderMenu()" title="Mehr Optionen">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/>
                        </svg>
                    </button>
                    <div id="headerDropdown" class="dropdown-content">
                        <button class="dropdown-item-flex" onclick="openCloudSettings(); toggleHeaderMenu();">
                            <span class="item-icon" id="cloudIcon">🔌</span>
                            <span class="item-text" id="cloudText">Offline</span>
                            <span id="cloudStatusIndicator" class="status-indicator disconnected"></span>
                        </button>
                        <button class="dropdown-item-flex" onclick="openDateFilterModal(); toggleHeaderMenu();">
                            <span class="item-icon">🗓️</span>
                            <span class="item-text">Zeitraum filtern</span>
                            <span id="activeFilterBadge" class="status-indicator-badge"></span>
                        </button>
                        <button class="dropdown-item-flex" onclick="switchTab('cashflow'); toggleHeaderMenu();">
                            <span class="item-icon">💸</span>
                            <span class="item-text">Cashflow verwalten</span>
                        </button>
                        <button class="dropdown-item-flex" onclick="switchTab('history'); toggleHeaderMenu();">
                            <span class="item-icon">📜</span>
                            <span class="item-text">Historie öffnen</span>
                        </button>
                        <div class="dropdown-divider"></div>
                        <button onclick="togglePrivacyMode(); toggleHeaderMenu();">👁️ Privatsphäre-Modus</button>
                        <button onclick="toggleCompactMode(); toggleHeaderMenu();">📱 Kompakte Ansicht</button>
                        <button onclick="toggleBiometric(); toggleHeaderMenu();">🔐 Bio Auth</button>
                        <button onclick="exportPDF(); toggleHeaderMenu();">📄 PDF Export</button>
                        <button onclick="exportJSON(); toggleHeaderMenu();">💾 JSON Backup</button>
                        <button onclick="exportCSV(); toggleHeaderMenu();">📊 CSV Export</button>
                        <div class="dropdown-divider"></div>
                        <button onclick="switchTab('settings'); toggleHeaderMenu();">⚙️ Einstellungen</button>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('dashboard')" title="Alt+1" data-tab="dashboard">📊 Dashboard</button>
            <button class="tab-btn" onclick="switchTab('entry')" title="Alt+2" data-tab="entry">📝 Neuer Eintrag</button>
            <button class="tab-btn" onclick="switchTab('platforms')" title="Alt+3" data-tab="platforms">💼 Plattformen</button>
            <button class="tab-btn" onclick="switchTab('notes')" title="Alt+5" data-tab="notes">🗒️ Notizen</button>
            <button class="tab-btn" onclick="switchTab('settings')" title="Alt+6" data-tab="settings">⚙️ Einstellungen</button>
        </div>

        <!-- Versteckte Inputs für den Filter-Status -->
        <input type="hidden" id="filterStartDate">
        <input type="hidden" id="filterEndDate">

        <div id="dashboard" class="tab-content active">
            <div id="welcomeCard" class="section" style="display: none; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 16px;">👋</div>
                <h2 class="section-title" style="justify-content: center; margin-bottom: 16px;">Willkommen beim Portfolio Tracker!</h2>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Es sieht so aus, als hättest du noch keine Daten eingegeben. Starte jetzt mit deinem ersten Eintrag!</p>
                <button class="btn btn-success" onclick="switchTab('entry')">
                    <span>📝</span><span>Ersten Eintrag erstellen</span>
                </button>
            </div>

            <div id="dashboardContent">
                <div class="stats-grid" id="stats-widget">
                    <div class="stat-card">
                        <div class="stat-card-skeleton"></div>
                        <div class="stat-content">
                            <div class="stat-icon">💰</div>
                            <div class="stat-label">Portfolio Gesamtwert</div>
                            <div class="stat-value dollar-value" id="totalValue">$0</div>
                            <div class="stat-change" id="totalChange">
                                <span>📊</span>
                                <span id="totalChangeValue" class="dollar-value"></span>
                                <span id="totalChangePercent"></span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-skeleton"></div>
                        <div class="stat-content">
                            <div class="stat-icon">⚡</div>
                            <div class="stat-label">LETZTE VERÄNDERUNG</div>
                            <div class="stat-value" id="dailyChangePercent">-</div>
                            <div class="stat-change" id="dailyChangeAmount">
                                <span>💵</span>
                                <span id="dailyChangeValue" class="dollar-value">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-skeleton"></div>
                        <div class="stat-content">
                            <div class="stat-icon">💎</div>
                            <div class="stat-label">Netto Investiert (Zeitraum)</div>
                            <div class="stat-value dollar-value" id="netInvested">$0</div>
                            <div class="stat-change">
                                <span>💳</span>
                                <span id="netInvestedChange" class="dollar-value">Ein: $0 | Aus: $0</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-skeleton"></div>
                        <div class="stat-content">
                            <div class="stat-icon">🏆</div>
                            <div class="stat-label">Reale Performance (Zeitraum)</div>
                            <div class="stat-value dollar-value" id="totalProfit">$0</div>
                            <div class="stat-change">
                                <span>📊</span>
                                <span id="profitPercent">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section" id="portfolio-chart-widget">
                    <div class="section-header">
                        <div class="section-title"><span>📈</span><span>Portfolio Entwicklung</span></div>
                        <div class="chart-controls">
                            <button class="chart-timeframe-btn" onclick="setDateFilter('30d')">1M</button>
                            <button class="chart-timeframe-btn" onclick="setDateFilter('90d')">3M</button>
                            <button class="chart-timeframe-btn" onclick="setDateFilter('ytd')">YTD</button>
                            <button class="chart-timeframe-btn" onclick="setDateFilter('1y')">1J</button>
                            <button class="chart-timeframe-btn active" onclick="setDateFilter('all')">MAX</button>
                        </div>
                        <button class="btn btn-primary btn-small" onclick="exportChart('portfolioChartContainer')" title="Ctrl+E">📷 Export</button>
                    </div>
                    <div class="chart-container" id="portfolioChartContainer">
                         <div class="chart-skeleton"></div>
                        <canvas id="portfolioChart"></canvas>
                    </div>
                    <div id="chart-performance-legend" class="chart-performance-legend"></div>
                </div>
                
                <div class="two-column-layout" id="details-widgets">
                    <div class="section">
                        <div class="section-header">
                            <div class="section-title"><span>ℹ️</span><span>Portfolio-Analyse</span></div>
                        </div>
                        <div id="keyMetrics" class="metrics-grid">
                            <div id="keyMetrics" class="metrics-grid">
                                <div class="metric-item">
                                    <span class="metric-label">Start</span>
                                    <span class="metric-value" id="metricStartDate">-</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Laufzeit</span>
                                    <span class="metric-value" id="metricDuration">-</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Startkapital</span>
                                    <span class="metric-value dollar-value" id="metricStartCapital">-</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Rendite (Gesamt)</span>
                                    <span class="metric-value" id="metricTotalReturnPercent">-</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Rendite Summe</span>
                                    <span class="metric-value dollar-value" id="metricTotalReturnSum">-</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Rendite Ø (Monat)</span>
                                    <span class="metric-value" id="metricAvgMonthlyReturn">-</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Rendite Prognose (Jahr)</span>
                                    <span class="metric-value" id="metricAnnualForecast">-</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Max. Drawdown</span>
                                    <span class="metric-value" id="metricMaxDrawdown">-</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Portfolio Prognose (Jahr)</span>
                                    <span class="metric-value dollar-value" id="metricPortfolioForecast">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="section">
                        <div class="section-header">
                            <div class="section-title"><span>🏰</span><span>Portfolio-Verteilung</span></div>
                             <button class="btn btn-primary btn-small" onclick="exportChart('allocationChartContainer')" title="Ctrl+E">📷 Export</button>
                        </div>
                        <div class="chart-container" id="allocationChartContainer">
                            <div class="chart-skeleton"></div>
                            <canvas id="allocationChart"></canvas>
                        </div>
                    </div>
                </div>
                <!-- NEUES, VERBESSERTES PROGNOSE-WIDGET -->
                <div id="forecastWidget" class="section" style="display: none;">
                    <div class="forecast-header">
                        <div>
                            <div class="forecast-title">🔮 Portfolio Prognose</div>
                            <p class="forecast-subtitle">
                                Basierend auf historischer Performance und verschiedenen Szenarien.<br>
                                Vergangene Performance ist keine Garantie für zukünftige Ergebnisse.
                            </p>
                        </div>
                        <div class="forecast-controls">
                            <div class="time-selector">
                                <button class="time-btn" onclick="setForecastPeriod(3)">3 Jahre</button>
                                <button class="time-btn active" onclick="setForecastPeriod(5)">5 Jahre</button>
                                <button class="time-btn" onclick="setForecastPeriod(10)">10 Jahre</button>
                            </div>
                            <button class="scenario-toggle" onclick="toggleScenarios()">
                                📊 Szenarien
                            </button>
                        </div>
                    </div>

                    <div class="forecast-metrics">
                        <div class="metric-card">
                            <span class="metric-icon">🎯</span>
                            <div class="metric-value" id="forecastMetricRealisticValue">$0</div>
                            <div class="metric-label" id="forecastMetricRealisticLabel">Erwarteter Wert (5J)</div>
                        </div>
                        <div class="metric-card success">
                            <span class="metric-icon">📈</span>
                            <div class="metric-value" id="forecastMetricAnnualReturn">-</div>
                            <div class="metric-label">Jährliche Rendite</div>
                        </div>
                        <div class="metric-card warning">
                            <span class="metric-icon">💰</span>
                            <div class="metric-value" id="forecastMetricTotalProfit">$0</div>
                            <div class="metric-label">Prognostizierter Gewinn</div>
                        </div>
                        <div class="metric-card danger">
                            <span class="metric-icon">📉</span>
                            <div class="metric-value" id="forecastMetricConservativeValue">$0</div>
                            <div class="metric-label" id="forecastMetricConservativeLabel">"Pessimistisch" (5J)</div>
                        </div>
                    </div>

                    <div class="forecast-chart-container">
                        <canvas id="forecastChart"></canvas>
                    </div>

                    <div class="scenario-cards">
                        <div class="scenario-card conservative">
                            <div class="scenario-header">
                                <div class="scenario-icon">🛡️</div>
                                <div>
                                    <div class="scenario-title">Konservativ</div>
                                    <div class="scenario-subtitle" id="conservativeReturnLabel">Vorsichtige Schätzung</div>
                                </div>
                            </div>
                            <div class="scenario-value" id="conservativeValue">$0</div>
                            <div class="probability-bar">
                                <div class="probability-fill"></div>
                            </div>
                            <div class="scenario-details">
                                Berücksichtigt niedrigere Marktrenditen und höhere Volatilität. 
                                Wahrscheinlichkeit: 25%
                            </div>
                        </div>

                        <div class="scenario-card realistic">
                            <div class="scenario-header">
                                <div class="scenario-icon">🎯</div>
                                <div>
                                    <div class="scenario-title">Realistisch</div>
                                    <div class="scenario-subtitle" id="realisticReturnLabel">Bisherige Performance</div>
                                </div>
                            </div>
                            <div class="scenario-value" id="realisticValue">$0</div>
                            <div class="probability-bar">
                                <div class="probability-fill"></div>
                            </div>
                            <div class="scenario-details">
                                Basiert auf historischer Portfolio-Performance und Markttrends. 
                                Wahrscheinlichkeit: 50%
                            </div>
                        </div>

                        <div class="scenario-card optimistic">
                            <div class="scenario-header">
                                <div class="scenario-icon">🚀</div>
                                <div>
                                    <div class="scenario-title">Optimistisch</div>
                                    <div class="scenario-subtitle" id="optimisticReturnLabel">Starkes Wachstum</div>
                                </div>
                            </div>
                            <div class="scenario-value" id="optimisticValue">$0</div>
                            <div class="probability-bar">
                                <div class="probability-fill"></div>
                            </div>
                            <div class="scenario-details">
                                Optimiert für Wachstumsmärkte und starke Portfolio-Performance. 
                                Wahrscheinlichkeit: 25%
                            </div>
                        </div>
                    </div>

                    <div class="disclaimer">
                        <span class="disclaimer-icon">⚠️</span>
                        <strong>Wichtiger Hinweis:</strong> Diese Prognosen sind Schätzungen basierend auf historischen Daten 
                        und mathematischen Modellen. Tatsächliche Ergebnisse können erheblich abweichen. Investitionen sind 
                        mit Risiken verbunden und vergangene Performance ist keine Garantie für zukünftige Ergebnisse.
                    </div>
                </div>
            </div>
        </div>

        <div id="entry" class="tab-content">
             <div class="section">
                <div class="section-header">
                    <div class="section-title"><span>📝</span><span>Neuer Eintrag</span></div>
                    <div>
                        <button class="btn btn-success pulse" onclick="saveAllEntries()" title="Ctrl+S">
                            <span>💾</span><span>Alle Speichern</span>
                        </button>
                    </div>
                </div>

                <div class="entry-date-bar">
                    <div class="date-bar-group">
                        <span class="date-bar-label">📅 Datum</span>
                        <input type="date" id="entryDate" class="date-input compact">
                    </div>
                    <div class="date-bar-actions">
                        <button class="btn btn-secondary btn-small" onclick="setToToday()">Heute</button>
                        <button class="btn btn-secondary btn-small" onclick="setToYesterday()">Gestern</button>
                        <button class="btn btn-secondary btn-small" onclick="loadLastEntries()">🔁 Letzte Einträge laden</button>
                    </div>
                </div>

                <div class="entry-layout">
                    <aside class="entry-context">
                        <details class="entry-fold" id="entrySummaryFold" hidden>
                            <summary class="entry-fold-summary">📊 Zusammenfassung</summary>
                            <div class="entry-fold-body">
                                <div id="entrySummary" class="summary-list">
                                    <div class="summary-item">
                                        <span class="summary-label">Aktive Plattformen</span>
                                        <span class="summary-value" id="summaryActiveCount">0</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">Neuer Gesamtwert</span>
                                        <span class="summary-value" id="summaryTotalValue">$0</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">Veränderung</span>
                                        <span class="summary-value" id="summaryDeltaValue">$0</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">Ungespeichert</span>
                                        <span class="summary-value" id="summaryPendingCount">0</span>
                                    </div>
                                </div>
                            </div>
                        </details>

                        <details class="entry-fold" id="dayStrategyFold">
                            <summary class="entry-fold-summary">🎯 Tages-Strategie</summary>
                            <div class="entry-fold-body" id="dayStrategyContainer">
                                <textarea id="dailyStrategy" class="strategy-area" rows="4" placeholder="z.B. Absicherung, Rebalancing..." onkeydown="if(event.key === 'Enter' && event.metaKey) { event.preventDefault(); saveStrategyOnly(); }"></textarea>
                                <div class="entry-fold-actions">
                                    <button class="btn btn-primary btn-small" onclick="saveStrategyOnly()">💾 Strategie speichern</button>
                                </div>
                            </div>
                        </details>

                        <details class="entry-fold" id="quickActionsFold">
                            <summary class="entry-fold-summary">⚡ Schnellaktionen</summary>
                            <div class="entry-fold-body">
                                <div class="entry-toolbar-status" id="entryLoadStatus">Noch keine Auswahl aktiv.</div>
                                <div class="entry-fold-actions stacked">
                                    <button class="btn btn-secondary" onclick="selectFavoritePlatformsForEntry()">⭐ Favoriten übernehmen</button>
                                    <button class="btn btn-secondary" onclick="selectPlatformsWithBalance()">💰 Mit Bestand</button>
                                    <button class="btn btn-secondary" onclick="openCashflowFromEntry()">💸 Cashflow verbuchen</button>
                                    <button class="btn btn-secondary" onclick="clearEntryInputs()">♻️ Zurücksetzen</button>
                                </div>
                            </div>
                        </details>

                        <details class="entry-fold" id="favoritesFold">
                            <summary class="entry-fold-summary">⭐ Favoriten</summary>
                            <div class="entry-fold-body">
                                <p class="entry-fold-subtext">Ziehe Plattformen hierher, um sie schnell zur täglichen Erfassung hinzuzufügen.<br> Tipp: Stern erneut anklicken oder ❌ nutzen, um Favoriten zu entfernen.</p>
                                <div id="favoritesGrid" class="favorites-zone"></div>
                            </div>
                        </details>

                        <div class="entry-hint-card">
                            💡 Beim Speichern kannst du nicht ausgewählte Plattformen automatisch auf 0 setzen.
                        </div>
                    </aside>

                    <section class="entry-main">
                        <details class="platform-selector">
                            <summary class="platform-selector-summary">
                                <div class="summary-main">🦄 Plattformen auswählen</div>
                                <div class="summary-hint">Klicken zum Ein- oder Ausblenden</div>
                            </summary>
                            <div class="platform-selector-body">
                                <div class="main-toolbar">
                                    <div class="main-search">
                                        <div class="platform-search-container">
                                            <input type="text" id="platformSearch" class="platform-search" placeholder="Plattform suchen... (Ctrl+F)" oninput="filterPlatforms()" onkeydown="handleSearchKeydown(event)">
                                            <span class="search-icon">🔍</span>
                                            <div id="autocompleteDropdown" class="autocomplete-dropdown"></div>
                                        </div>
                                    </div>
                                    <div class="main-filters">
                                        <button class="category-btn active" onclick="filterCategory(this, 'all')">Alle</button>
                                        <button class="category-btn" onclick="filterCategory(this, 'Exchange')">Exchanges</button>
                                        <button class="category-btn" onclick="filterCategory(this, 'DeFi')">DeFi</button>
                                        <button class="category-btn" onclick="filterCategory(this, 'Lending')">Lending</button>
                                        <button class="category-btn" onclick="filterCategory(this, 'Wallet')">Wallets</button>
                                    </div>
                                </div>
                                <div class="platform-grid" id="platformGrid"></div>
                            </div>
                        </details>

                        <div id="autoZeroHint" class="auto-zero-hint">
                            💡 <b>Tipp:</b> Wenn du jetzt speicherst, kannst du nicht ausgewählte Plattformen, die vorher Kapital hatten, automatisch auf 0 setzen.
                        </div>

                        <div id="platformInputs" class="input-grid entry-input-grid"></div>
                    </section>
                </div>

            </div>
        </div>

        <div id="cashflow" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <div class="section-title"><span>💸</span><span>Cashflow Management</span></div>
                </div>
                
                <div class="cashflow-stats">
                    <div class="cashflow-stat">
                        <div class="cashflow-stat-label">➕ Total Eingezahlt</div>
                        <div class="cashflow-stat-value positive dollar-value" id="totalDeposits">$0</div>
                    </div>
                    <div class="cashflow-stat">
                        <div class="cashflow-stat-label">➖ Total Ausgezahlt</div>
                        <div class="cashflow-stat-value negative dollar-value" id="totalWithdrawals">$0</div>
                    </div>
                    <div class="cashflow-stat">
                        <div class="cashflow-stat-label">💎 Netto Investiert</div>
                        <div class="cashflow-stat-value dollar-value" id="netCashflow">$0</div>
                    </div>
                    <div class="cashflow-stat">
                        <div class="cashflow-stat-label">📊 ROI</div>
                        <div class="cashflow-stat-value" id="roiPercent">0%</div>
                    </div>
                </div>

                <div class="cashflow-form">
                    <div class="cashflow-field">
                        <label class="cashflow-label">Typ:</label>
                        <div class="cashflow-type">
                            <label class="radio-option">
                                <input type="radio" name="cashflowType" value="deposit" checked>
                                <span>➕ Einzahlung</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="cashflowType" value="withdraw">
                                <span>➖ Auszahlung</span>
                            </label>
                        </div>
                    </div>
                    <div class="cashflow-field">
                        <label class="cashflow-label">Betrag (USD):</label>
                        <input type="text" id="cashflowAmount" class="input-field" placeholder="1000" inputmode="decimal">
                    </div>
                    <div class="cashflow-field">
                        <label class="cashflow-label">Datum:</label>
                        <input type="date" id="cashflowDate" class="date-input">
                    </div>
                    <div class="cashflow-field" id="cashflowTargetDiv">
                        <label class="cashflow-label">Ziel-Plattform:</label>
                        <select id="cashflowTarget" class="input-field"></select>
                    </div>
                    <div class="cashflow-field">
                        <label class="cashflow-label">Notiz:</label>
                        <input type="text" id="cashflowNote" class="input-field" placeholder="Optional...">
                    </div>
                    <div class="cashflow-actions">
                        <button class="btn btn-success cashflow-save-btn" onclick="saveCashflow()" title="Ctrl+S">
                            <span>💾</span><span>Speichern</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <div class="section-title"><span>📜</span><span>Cashflow Historie</span></div>
                    <div class="view-switcher">
                        <button class="view-btn active" onclick="setCashflowView('list')">Liste</button>
                        <button class="view-btn" onclick="setCashflowView('month')">Monat</button>
                        <button class="view-btn" onclick="setCashflowView('quarter')">Quartal</button>
                    </div>
                </div>
                <div id="cashflowDisplayContainer" class="cashflow-display-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="date">Datum <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="type">Typ <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="amount">Betrag <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="platform">Plattform <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="note">Notiz <span class="sort-arrow"></span></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="cashflowTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="platforms" class="tab-content">
             <div class="section">
                <div class="section-header">
                    <div class="section-title"><span>💼</span><span>Platform Details</span></div>
                </div>
                <div class="data-table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="platform">Plattform <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="entries">Einträge <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="first">Erster Eintrag <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="last">Letzter Eintrag <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="avg">Avg Balance <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="total">Total Return <span class="sort-arrow"></span></th>
                            </tr>
                        </thead>
                        <tbody id="platformDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="history" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <div class="section-title"><span>📜</span><span>Eintrags-Historie</span></div>
                    <div class="view-switcher">
                        <button class="view-btn active" onclick="setHistoryView('list')">Liste</button>
                        <button class="view-btn" onclick="setHistoryView('grouped')">Nach Plattform</button>
                        <button class="view-btn" onclick="setHistoryView('bydate')">Nach Datum</button>
                    </div>
                    <input type="text" id="historySearch" class="input-field" placeholder="In Liste suchen..." style="width: 200px;">
                </div>
                <div id="historyListView">
                    <div class="data-table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllHistory" title="Alle auswählen"></th>
                                    <th class="sortable" data-sort="date">Datum <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="protocol">Plattform <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="balance">Balance <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="strategy">Strategie <span class="sort-arrow"></span></th>
                                    <th>Notiz</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <div id="historyMobileCards" class="mobile-cards">
                    <!-- Mobile card layout wird hier von JavaScript eingefügt -->
                </div>
                <div id="historyBulkActions" class="bulk-actions-bar">
                    <span id="bulkSelectedCount">0 Einträge ausgewählt</span>
                    <div class="bulk-actions-buttons">
                        <button class="btn btn-primary btn-small" onclick="bulkChangeDate()">
                            <span>🗓️</span> Datum ändern
                        </button>
                        <button class="btn btn-primary btn-small" onclick="bulkChangeAmount()">
                            <span>💰</span> Betrag ändern
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteSelectedEntries()">
                            <span>🗑️</span> Auswahl löschen
                        </button>
                    </div>
                </div>
                <div id="historyGroupedView" style="display: none;">
                    <!-- Gruppierte Ansicht wird hier von JavaScript eingefügt -->
                </div>
                <div id="historyByDateView" style="display: none;">
                    <!-- Neue, nach Datum gruppierte Ansicht -->
                </div>
            </div>
        </div>

        <div id="notes" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <div class="section-title"><span>🗒️</span><span>Notizbuch</span></div>
                    <div class="notes-toolbar">
                        <input type="text" id="notesSearchInput" class="input-field" placeholder="Notizen durchsuchen...">
                        <button class="btn btn-primary btn-small" type="button" id="notesNewBtn">➕ Neue Notiz</button>
                    </div>
                    <div class="notes-filter-bar">
                        <button type="button" class="notes-filter-chip" id="notePinnedFilterBtn" aria-pressed="false">📌 Angepinnt</button>
                        <div class="notes-tag-filter" id="noteTagFilters"></div>
                        <div class="notes-sort-group">
                            <label for="noteSortSelect">Sortieren:</label>
                            <select id="noteSortSelect" class="notes-sort-select">
                                <option value="updated-desc">Zuletzt aktualisiert</option>
                                <option value="updated-asc">Älteste zuerst</option>
                                <option value="created-desc">Erstellt (neueste)</option>
                                <option value="created-asc">Erstellt (älteste)</option>
                                <option value="title-asc">Titel A → Z</option>
                                <option value="title-desc">Titel Z → A</option>
                            </select>
                        </div>
                        <button type="button" class="notes-filter-reset" id="noteFilterResetBtn" disabled>Filter zurücksetzen</button>
                    </div>
                </div>
                <div class="note-editor" id="noteEditor">
                    <div class="note-editor-content">
                        <div class="note-editor-form">
                            <input type="text" id="noteTitleInput" class="input-field" placeholder="Titel der Notiz">
                        <div class="note-rich-editor">
                            <div class="note-toolbar" id="noteToolbar">
                                <button type="button" class="note-tool" data-command="bold" title="Fett">B</button>
                                <button type="button" class="note-tool" data-command="italic" title="Kursiv">I</button>
                                <button type="button" class="note-tool" data-command="underline" title="Unterstreichen">U</button>
                                <span class="note-toolbar-separator"></span>
                                <button type="button" class="note-tool" data-command="insertUnorderedList" title="Liste">• List</button>
                                <button type="button" class="note-tool" data-command="insertOrderedList" title="Nummerierte Liste">1. List</button>
                                <span class="note-toolbar-separator"></span>
                                <label class="note-color-picker" title="Textfarbe">
                                    🎨
                                    <input type="color" id="noteColorPicker" value="#3b82f6">
                                </label>
                                <button type="button" class="note-tool" data-command="removeFormat" title="Formatierung entfernen">⨯</button>
                            </div>
                            <div id="noteContentEditor" class="note-content-editor" contenteditable="true" role="textbox" aria-multiline="true" data-placeholder="Was möchtest du festhalten?"></div>
                            <textarea id="noteContentInput" class="note-content-hidden" aria-hidden="true"></textarea>
                        </div>
                        <div class="note-tags-group">
                            <input type="text" id="noteTagsInput" class="input-field" placeholder="Tags mit Komma trennen (z.B. DeFi, Ideen)">
                            <div id="noteTagChips" class="note-tag-chips"></div>
                        </div>
                            <div class="note-editor-footer">
                                <label class="file-upload" for="noteAttachmentInput">
                                    <input type="file" id="noteAttachmentInput" accept="image/*" multiple>
                                    <span>📎 Screenshots anhängen</span>
                                </label>
                                <div class="note-editor-actions">
                                    <label class="note-pin-toggle">
                                        <input type="checkbox" id="notePinnedToggle">
                                        <span>📌 Wichtig markieren</span>
                                    </label>
                                    <button class="btn btn-secondary btn-small" type="button" id="noteCancelBtn">Zurücksetzen</button>
                                    <button class="btn btn-success btn-small" type="button" id="noteSaveBtn">Speichern</button>
                                </div>
                                <div id="noteDraftStatus" class="note-draft-status"></div>
                            </div>
                        </div>
                    </div>
                    <div id="noteAttachmentPreview" class="note-attachments"></div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <div class="section-title"><span>📚</span><span>Meine Notizen</span></div>
                    <div id="notesStats" class="notes-meta"></div>
                </div>
                <div id="notesEmptyState" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">🗒️</div>
                    <h3>Keine Notizen gespeichert</h3>
                    <p>Halte spontane Ideen, wichtige Todos oder Links fest. Über den Button oben kannst du Screenshots hinzufügen.</p>
                </div>
                <div class="notes-sections">
                    <div class="notes-group" id="notesPinnedGroup" style="display: none;">
                        <div class="notes-group-title">📌 Angepinnt</div>
                        <div id="notesPinned" class="notes-list pinned"></div>
                    </div>
                    <div class="notes-group" id="notesRegularGroup">
                        <div class="notes-group-title">Alle Notizen</div>
                        <div id="notesRegular" class="notes-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="settings" class="tab-content">
            <div class="section">
                <details open>
                    <summary class="section-header-summary">
                        <div class="section-title"><span>☁️</span><span>Cloud Sync Einstellungen</span></div>
                        <span class="summary-arrow">▼</span>
                    </summary>
                    <div class="details-content" style="padding-top: 16px;">
                        <div id="connectionStatus" class="connection-status disconnected">
                            <span>⚠️</span>
                            <span>Nicht verbunden - Konfiguriere GitHub für Cloud Sync</span>
                        </div>

                        <div class="info-box">
                            <h3>📝 Wie funktioniert der Cloud Sync?</h3>
                            <p>
                                Deine Daten werden in einem privaten GitHub Gist gespeichert. 
                                Nur du hast Zugriff darauf. Du benötigst einen GitHub Account und ein Personal Access Token.
                            </p>
                        </div>

                        <div class="settings-grid">
                            <div class="setting-item">
                                <div class="setting-label">GitHub Token</div>
                                <div class="setting-value" id="tokenDisplay">Nicht konfiguriert</div>
                                <div class="setting-actions">
                                    <button class="btn btn-primary btn-small" onclick="setupGitHubToken()">Token setzen</button>
                                    <button class="btn btn-danger btn-small" onclick="clearGitHubToken()">Löschen</button>
                                </div>
                            </div>
                            
                            <div class="setting-item" style="display: none;">
                                <div class="setting-label">Gist ID</div>
                                <div class="setting-value" id="gistDisplay">Nicht konfiguriert</div>
                                <div class="setting-actions">
                                    <button class="btn btn-primary btn-small" onclick="setupGistId()">Gist ID setzen</button>
                                    <button class="btn btn-success btn-small" onclick="createNewGist()">Neu erstellen</button>
                                     <button class="btn btn-danger btn-small" onclick="clearGistId()">Löschen</button>
                                </div>
                            </div>

                            <div class="setting-item">
                                <div class="setting-label">Auto-Sync</div>
                                <div class="setting-value">
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="autoSyncToggle" onchange="toggleAutoSync()">
                                        <span>Bei jeder Änderung automatisch synchronisieren</span>
                                    </label>
                                </div>
                            </div>

                            <div class="setting-item">
                                <div class="setting-label">Letzter Sync</div>
                                <div class="setting-value" id="lastSyncDisplay">Noch nie synchronisiert</div>
                                <div class="setting-actions">
                                    <button class="btn btn-success btn-small" onclick="syncNow()">Jetzt synchronisieren</button>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="testConnection()">
                                <span>🔌</span><span>Verbindung testen</span>
                            </button>
                        </div>
                    </div>
                </details>
            </div>
            
            <div class="section">
                <details>
                    <summary class="section-header-summary">
                        <div class="section-title"><span>💾</span><span>Backup & Wiederherstellung</span></div>
                        <span class="summary-arrow">▼</span>
                    </summary>
                    <div class="details-content">
                        <div class="settings-grid" style="margin-top: 16px;">
                            <div class="setting-item">
                                <div class="setting-label">Lokales Backup</div>
                                <div class="setting-value">Stellt den Zustand vom letzten Speichern wieder her.</div>
                                <div class="setting-actions">
                                    <button class="btn btn-warning btn-small" onclick="restoreFromLocalBackup()">Aus lokalem Backup wiederherstellen</button>
                                </div>
                            </div>
                        </div>
                        <div class="info-box" style="margin-top: 24px;">
                            <h3>💡 Deine Backup-Strategie</h3>
                            <p>Deine Daten sind mehrfach gesichert:</p>
                            <ul>
                                <li><b>Lokal (Automatisch):</b> Bei jeder Speicherung wird ein Backup in der robusten IndexedDB deines Browsers angelegt. Dies dient als schnelle, lokale Absicherung.</li>
                                <li><b>Cloud (Empfohlen):</b> Die Synchronisierung mit GitHub (siehe oben) ist die sicherste Methode, um deine Daten geräteübergreifend zu sichern und wiederherzustellen.</li>
                                <li><b>Manuell (Export):</b> Du kannst deine Daten jederzeit als JSON- oder CSV-Datei exportieren und an einem sicheren Ort speichern.</li>
                            </ul>
                        </div>
                    </div>
                </details>
            </div>
            
            <!-- Ansicht & Bedienung Section -->
            <div class="section">
                <details>
                    <summary class="section-header-summary">
                        <div class="section-title"><span>🎨</span><span>Ansicht & Bedienung</span></div>
                        <span class="summary-arrow">▼</span>
                    </summary>
                    <div class="details-content">
                        <div class="settings-grid" style="margin-top: 16px;">
                            <div class="setting-item">
                                <div class="setting-label">Kompakte Ansicht</div>
                                <div class="setting-value">
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="compactModeToggle" onchange="toggleCompactMode()">
                                        <span>Optimiert für kleine Bildschirme</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>
            </div>

            <!-- Neue Section in Settings Tab -->
            <div class="section">
                <details>
                    <summary class="section-header-summary">
                        <div class="section-title"><span>🗂️</span><span>Daten Management</span></div>
                        <span class="summary-arrow">▼</span>
                    </summary>
                    <div class="details-content">
                        <div class="settings-grid" style="margin-top: 16px;">
                            <div class="setting-item">
                                <div class="setting-label">📤 Export Optionen</div>
                                <div class="setting-value">Sichere deine Daten in verschiedenen Formaten</div>
                                <div class="setting-actions">
                                    <button class="btn btn-primary btn-small" onclick="exportJSON()">JSON</button>
                                    <button class="btn btn-primary btn-small" onclick="exportCSV()">CSV</button>
                                    <button class="btn btn-primary btn-small" onclick="exportPDF()">PDF</button>
                                </div>
                            </div>
                            
                            <div class="setting-item">
                                <div class="setting-label">📥 Import</div>
                                <div class="setting-value">Lade bestehende Daten</div>
                                <div class="setting-actions">
                                    <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
                                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                                    <button class="btn btn-primary btn-small" onclick="document.getElementById('jsonFileInput').click()">JSON</button>
                                    <button class="btn btn-primary btn-small" onclick="document.getElementById('csvFileInput').click()">CSV</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Danger Zone -->
                        <div class="danger-zone">
                            <h3>⚠️ Gefahrenbereich</h3>
                            <p>Diese Aktionen können nicht rückgängig gemacht werden! Das Leeren des Caches kann bei API-Problemen helfen.</p>
                            <div class="danger-actions">
                                <button class="btn btn-warning" onclick="clearApiCache()">🔄 API Cache leeren</button>
                                <button class="btn btn-danger" onclick="resetPlatforms()">Plattformen zurücksetzen</button>
                                <button class="btn btn-danger" onclick="clearAllData()">🗑️ Alle Daten löschen</button>
                            </div>
                        </div>
                    </div>
                </details>
            </div>
        </div>
    </div>
    
    <div id="bottomSheet" class="bottom-sheet-overlay">
        <div class="bottom-sheet-content">
            <div class="bottom-sheet-header">
                <div class="bottom-sheet-drag-handle"></div>
            </div>
            <div id="bottomSheetBody" class="bottom-sheet-body">
                </div>
        </div>
    </div>

    <div id="notification" class="notification">
        <span id="notificationIcon">✅</span>
        <span id="notificationText">Gespeichert!</span>
    </div>

    <!-- Globale Suche Modal -->
    <div id="globalSearchOverlay" class="global-search-overlay">
        <div id="globalSearchModal" class="global-search-modal">
            <div class="search-input-wrapper">
                <input type="text" id="globalSearchInput" placeholder="Suche nach Plattformen, Einträgen, Aktionen...">
                <button class="btn btn-small" onclick="exportSearchResults()" title="Suchergebnisse exportieren">💾</button>
                <span class="search-modal-close" onclick="closeGlobalSearch()">✕</span>
            </div>
            <div id="searchFilters" class="search-filters" style="display: none;">
                <!-- Filter werden hier dynamisch eingefügt -->
            </div>
            <div class="search-quick-filters">
                <button class="btn btn-small" onclick="setDateRangeFilter('heute')">📅 Heute</button>
                <button class="btn btn-small" onclick="setDateRangeFilter('woche')">📅 Diese Woche</button>
                <button class="btn btn-small" onclick="setDateRangeFilter('monat')">📅 Dieser Monat</button>
                <button class="btn btn-small" onclick="toggleSearchFilter('category', 'Exchange')">🏦 Exchange</button>
                <button class="btn btn-small" onclick="toggleSearchFilter('category', 'DeFi')">🔄 DeFi</button>
                <button class="btn btn-small" onclick="toggleSearchFilter('tag', 'high-risk')">⚠️ High-Risk</button>
            </div>
            <div id="globalSearchResults" class="global-search-results">
                <!-- Ergebnisse werden hier dynamisch eingefügt -->
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <!-- Mobile Bottom Navigation mit mehr Funktionen -->
    <div class="mobile-bottom-nav" style="display: none;">
        <button class="mobile-nav-item active" data-tab="dashboard" onclick="switchTab('dashboard')">
            <span class="nav-icon">📊</span>
        </button>
        <button class="mobile-nav-item" data-tab="entry" onclick="switchTab('entry')">
            <span class="nav-icon">➕</span>
        </button>
        <button class="mobile-nav-item" data-tab="notes" onclick="switchTab('notes')">
            <span class="nav-icon">🗒️</span>
        </button>
        <!-- Search -->
        <button class="mobile-nav-item" onclick="document.getElementById('globalSearchBtn').click()">
            <span class="nav-icon">🔍</span>
        </button>
        <!-- Theme Toggle -->
        <button class="mobile-nav-item" onclick="toggleTheme()">
            <span class="nav-icon theme-icon">🌙</span>
        </button>
        <!-- Menu für Settings, Privacy etc. -->
        <button class="mobile-nav-item" onclick="openMobileMenu()">
            <span class="nav-icon">⋮</span>
        </button>
    </div>

    <div id="noteGalleryOverlay" class="note-gallery-overlay">
        <div class="note-gallery-content">
            <button type="button" class="note-gallery-close" id="noteGalleryClose" aria-label="Galerie schließen">✕</button>
            <div class="note-gallery-image-wrapper" id="noteGalleryImageWrapper">
                <div class="note-gallery-loader" id="noteGalleryLoader">
                    <span>⏳</span>
                </div>
                <img id="noteGalleryImage" alt="Notiz Anhang" class="note-gallery-image">
            </div>
            <div class="note-gallery-meta">
                <div id="noteGalleryCaption" class="note-gallery-caption"></div>
                <div class="note-gallery-controls">
                    <button type="button" id="noteGalleryPrev" class="note-gallery-nav" aria-label="Vorheriges Bild">←</button>
                    <span id="noteGalleryCounter" class="note-gallery-counter"></span>
                    <button type="button" id="noteGalleryNext" class="note-gallery-nav" aria-label="Nächstes Bild">→</button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Bottom Sheet Swipe-Logik ---
        const bottomSheetOverlay = document.getElementById('bottomSheet');
        const bottomSheetContent = bottomSheetOverlay.querySelector('.bottom-sheet-content');
        const bottomSheetHeader = bottomSheetOverlay.querySelector('.bottom-sheet-header');
        
        let bsTouchStartY = 0;
        let bsCurrentTranslateY = 0;

        if (bottomSheetHeader && bottomSheetContent) {
            bottomSheetHeader.addEventListener('touchstart', (e) => {
                bsTouchStartY = e.touches[0].clientY;
                bottomSheetContent.style.transition = 'none'; // Deaktiviert die CSS-Transition während des Ziehens
            }, { passive: true });

            bottomSheetHeader.addEventListener('touchmove', (e) => {
                const touchY = e.touches[0].clientY;
                const deltaY = touchY - bsTouchStartY;
                
                if (deltaY > 0) { // Nur nach unten ziehen erlauben
                    bsCurrentTranslateY = deltaY;
                    bottomSheetContent.style.transform = `translateY(${bsCurrentTranslateY}px)`;
                }
            });

            bottomSheetHeader.addEventListener('touchend', () => {
                if (bsCurrentTranslateY === 0) return;

                bottomSheetContent.style.transition = 'transform 0.3s ease-out';
                const sheetHeight = bottomSheetContent.offsetHeight;

                // Wenn mehr als 1/4 nach unten gezogen, schließen
                if (bsCurrentTranslateY > sheetHeight / 4) {
                    // Da wir die genaue Schließfunktion nicht kennen, verstecken wir das Element.
                    // Dies ist eine sichere Methode, die in den meisten Fällen funktionieren sollte.
                    // Idealerweise gäbe es eine Funktion wie `closeBottomSheet()`, die hier aufgerufen wird.
                    bottomSheetOverlay.style.display = 'none';
                    // Transform zurücksetzen für das nächste Öffnen
                    bottomSheetContent.style.transform = 'translateY(0)';
                } else {
                    // Zurück zur Ausgangsposition schnappen
                    bottomSheetContent.style.transform = 'translateY(0)';
                }

                bsCurrentTranslateY = 0;
                bsTouchStartY = 0;
            });
        }
    });
    </script>
</body>
</html>
