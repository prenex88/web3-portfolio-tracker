<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 Portfolio Tracker Pro - Cloud Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚀</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --gray: #6b7280;
            --light: #f9fafb;
            --white: #ffffff;
            --border: #e5e7eb;
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
        }

        body.dark-mode {
            --dark: #f9fafb;
            --gray: #9ca3af;
            --light: #1f2937;
            --white: #111827;
            --border: #374151;
            --bg-gradient: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            --card-bg: rgba(31, 41, 55, 0.95);
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Sync Status Bar */
        .sync-status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            z-index: 999;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .sync-status-bar.visible {
            transform: translateY(0);
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .sync-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .sync-indicator.synced { background: var(--success); }
        .sync-indicator.pending { background: var(--warning); }
        .sync-indicator.error { background: var(--danger); }
        .sync-indicator.offline { background: var(--gray); }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .sync-actions {
            display: flex;
            gap: 10px;
        }

        /* Header with Theme Toggle */
        .header {
            position: relative;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            animation: slideDown 0.5s ease;
        }

        body.has-sync-bar .header {
            margin-top: 50px;
        }
        
        .header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .cloud-status-badge {
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cloud-status-badge:hover {
            transform: scale(1.05);
        }

        .cloud-status-badge.disconnected {
            background: linear-gradient(135deg, var(--gray) 0%, var(--dark) 100%);
        }

        .cloud-status-badge.syncing {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        }

        .cloud-status-badge.error {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }

        .theme-toggle {
            padding: 8px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 12px;
            background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header .subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 20px;
        }

        /* Date Range Filter */
        .date-filter-bar {
            background: var(--card-bg);
            padding: 16px 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            box-shadow: var(--shadow-sm);
        }

        .date-filter-bar .filter-icon {
            font-size: 20px;
        }

        .date-filter-bar .filter-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .filter-btn {
            padding: 8px 16px;
            background: var(--white);
            color: var(--text-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .custom-date-range {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .date-input-small {
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            background: var(--white);
            color: var(--text-primary);
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: var(--card-bg);
            padding: 10px;
            border-radius: 16px;
            overflow-x: auto;
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        body.has-sync-bar .tab-navigation {
            top: 42px;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            color: var(--text-primary);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: 600;
        }

        .tab-btn:hover {
            background: var(--light);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 35px -5px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
            color: white;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* APR Toggle in Stat Card */
        .apr-stat-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .apr-toggle-switch {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .positive { color: var(--success); }
        .negative { color: var(--danger); }

        .section {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            animation: fadeIn 0.5s ease;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
            flex-wrap: wrap;
            gap: 10px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Platform Search */
        .platform-search-container {
            position: relative;
            margin-bottom: 16px;
        }

        .platform-search {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            background: var(--white);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .platform-search:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: var(--text-secondary);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: var(--white);
            color: var(--danger);
            border: 2px solid var(--danger);
        }
        .btn-danger:hover { 
            background: var(--danger); 
            color: white; 
        }

        .btn-small { 
            padding: 6px 12px; 
            font-size: 12px; 
        }

        /* Date Range Selector */
        .date-range-selector {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
            border-radius: 16px;
            flex-wrap: wrap;
        }

        .dark-mode .date-range-selector {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }

        .date-input {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            background: var(--white);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        .date-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Platform Grid with Categories */
        .category-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 6px 12px;
            background: var(--white);
            color: var(--text-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .category-btn:hover {
            border-color: var(--primary);
        }

        .category-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .platform-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
            max-height: 400px;
            overflow-y: auto;
            padding: 4px;
        }

        .platform-btn {
            padding: 16px;
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
        }
        
        .platform-btn.dragging {
            opacity: 0.5;
        }

        .platform-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        .platform-btn.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3);
        }
        .platform-btn .icon { font-size: 24px; margin-bottom: 8px; }
        .platform-btn .name { font-size: 13px; font-weight: 600; }
        .platform-btn .type { font-size: 10px; opacity: 0.7; margin-top: 4px; }
        .platform-btn .remove-tile {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            line-height: 1;
            cursor: pointer;
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.2s, transform 0.2s;
        }
        .platform-btn:hover .remove-tile {
            opacity: 1;
            transform: scale(1);
        }

        /* Input Grid with Notes */
        .input-grid { 
            display: grid; 
            gap: 16px; 
            margin-bottom: 24px; 
        }
        
        .input-card {
            background: linear-gradient(135deg, var(--light) 0%, var(--white) 100%);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .input-card:hover { 
            border-color: var(--primary); 
        }

        .input-row {
            display: grid;
            grid-template-columns: 200px 1fr 150px auto auto;
            gap: 16px;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .input-row {
                grid-template-columns: 1fr;
            }
        }

        .platform-name { 
            font-weight: 600; 
            color: var(--text-primary); 
            font-size: 15px; 
        }
        
        .input-field {
            padding: 10px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: var(--white);
            color: var(--text-primary);
        }
        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .note-input {
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            background: var(--white);
            color: var(--text-primary);
            min-width: 150px;
        }

        .last-value { 
            font-size: 12px; 
            color: var(--text-secondary);
            padding: 8px 12px;
            background: var(--light);
            border-radius: 8px;
        }
        
        .remove-btn {
            padding: 8px;
            background: var(--white);
            border: 2px solid var(--danger);
            color: var(--danger);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .remove-btn:hover { 
            background: var(--danger); 
            color: white; 
        }

        /* Cashflow Section */
        .cashflow-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 24px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
            border-radius: 16px;
            margin-bottom: 30px;
        }

        .dark-mode .cashflow-form {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }

        .cashflow-type {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .cashflow-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .cashflow-stat {
            padding: 20px;
            background: var(--white);
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }

        .cashflow-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .cashflow-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Data Tables */
        .data-table-wrapper {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
        }
        .data-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
        }
        .data-table th.sortable {
            cursor: pointer;
        }
        .data-table th.sortable:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #5b3a8e 100%);
        }
        .data-table th .sort-arrow {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
        }

        .data-table th:first-child { border-radius: 12px 0 0 12px; }
        .data-table th:last-child { border-radius: 0 12px 12px 0; }
        .data-table td {
            background: var(--white);
            color: var(--text-primary);
            padding: 16px;
            font-size: 14px;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }
        .data-table td.editable {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .data-table td.editable:hover {
            background-color: var(--light);
        }
        .data-table td:first-child { 
            border-left: 1px solid var(--border); 
            border-radius: 12px 0 0 12px; 
        }
        .data-table td:last-child { 
            border-right: 1px solid var(--border); 
            border-radius: 0 12px 12px 0; 
        }
        .data-table tr:hover td { 
            background: var(--light); 
        }

        /* APR Badge */
        .apr-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            display: inline-block;
        }
        .apr-high { 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
            color: white; 
        }
        .apr-medium { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
            color: white; 
        }
        .apr-low { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
            color: white; 
        }

        /* Transaction Type Badge */
        .type-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        .type-deposit { background: #d1fae5; color: #065f46; }
        .type-withdraw { background: #fee2e2; color: #991b1b; }

        /* Charts */
        .chart-container {
            height: 400px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
            border-radius: 16px;
            padding: 24px;
            position: relative;
        }

        .dark-mode .chart-container {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }

        .empty-state { 
            text-align: center; 
            padding: 40px; 
            color: var(--text-secondary); 
        }
        .empty-state-icon { 
            font-size: 48px; 
            margin-bottom: 16px; 
            opacity: 0.5; 
        }
        
        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: var(--white);
            color: var(--text-primary);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .modal-body {
            font-size: 16px;
            line-height: 1.6;
        }
        .modal-footer {
            text-align: right; 
            margin-top: 20px; 
            padding-top: 20px; 
            border-top: 1px solid var(--border);
        }
        
        /* APR Toggle Switch */
        .apr-toggle { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 12px; 
            color: var(--text-secondary); 
        }
        .switch { 
            position: relative; 
            display: inline-block; 
            width: 40px; 
            height: 22px; 
        }
        .switch input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
        }
        .slider { 
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: #ccc; 
            transition: .4s; 
            border-radius: 22px; 
        }
        .slider:before { 
            position: absolute; 
            content: ""; 
            height: 16px; 
            width: 16px; 
            left: 3px; 
            bottom: 3px; 
            background-color: white; 
            transition: .4s; 
            border-radius: 50%; 
        }
        input:checked + .slider { 
            background-color: var(--primary); 
        }
        input:checked + .slider:before { 
            transform: translateX(18px); 
        }

        /* Multi-column layouts */
        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        /* Save notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1001;
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Cloud Settings Modal */
        .github-setup-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .github-setup-modal.visible {
            display: flex;
        }

        .github-setup-content {
            background: var(--white);
            color: var(--text-primary);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
        }

        .github-setup-header {
            margin-bottom: 20px;
        }

        .github-setup-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .github-input-group {
            margin-bottom: 20px;
        }

        .github-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .github-input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            background: var(--light);
            color: var(--text-primary);
            font-family: monospace;
        }

        .github-input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .github-input-help {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .github-setup-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .connection-status {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .connection-status.connected {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        /* Settings Section */
        .settings-section {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .setting-item {
            padding: 20px;
            background: var(--light);
            border-radius: 12px;
            border: 2px solid var(--border);
        }

        .setting-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .setting-value {
            color: var(--text-secondary);
            font-size: 14px;
            word-break: break-all;
            font-family: monospace;
        }

        .setting-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }

        /* Info Box */
        .info-box {
            background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
            border-left: 4px solid var(--primary);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .dark-mode .info-box {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }

        .info-box h3 {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 16px;
        }

        .info-box p {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: rgba(0, 0, 0, 0.9);
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .two-column-layout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header-controls {
                position: static;
                margin-top: 20px;
            }
            
            .tab-navigation {
                overflow-x: auto;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .date-range-selector {
                flex-direction: column;
                align-items: stretch;
            }
            
            .platform-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .date-filter-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .custom-date-range {
                margin-left: 0;
                margin-top: 10px;
            }

            .sync-status-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        /* Animations */
        @keyframes slideDown { 
            from { opacity: 0; transform: translateY(-20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }
        .pulse { 
            animation: pulse 2s infinite; 
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }
            
            .header-controls,
            .tab-navigation,
            .btn,
            .remove-tile,
            .remove-btn {
                display: none !important;
            }
            
            .section {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <!-- Sync Status Bar -->
    <div id="syncStatusBar" class="sync-status-bar">
        <div class="sync-status">
            <div id="syncIndicator" class="sync-indicator offline"></div>
            <span id="syncStatusText">Offline Modus</span>
            <span id="lastSyncTime" style="color: var(--text-secondary); font-size: 12px;"></span>
        </div>
        <div class="sync-actions">
            <button id="syncNowBtn" class="btn btn-primary btn-small" onclick="syncNow()">
                <span id="syncBtnIcon">☁️</span>
                <span id="syncBtnText">Sync</span>
            </button>
            <button class="btn btn-small" onclick="toggleSyncBar()">✕</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-controls">
                <div id="cloudStatusBadge" class="cloud-status-badge disconnected" onclick="openCloudSettings()">
                    <span id="cloudIcon">☁️</span>
                    <span id="cloudText">Offline</span>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()" title="Theme wechseln">🌙</button>
                <button class="btn btn-danger btn-small" onclick="resetPlatforms()"><span>🔄</span> Reset</button>
                <button class="btn btn-primary btn-small" onclick="exportPDF()"><span>📄</span> PDF Export</button>
            </div>
            <h1>🚀 Web3 Portfolio Tracker Pro</h1>
            <div class="subtitle">Advanced Portfolio Management mit Cloud Sync</div>
        </div>

        <div class="date-filter-bar">
            <span class="filter-icon">📅</span>
            <span class="filter-label">Zeitraum Filter:</span>
            <button class="filter-btn active" onclick="setDateFilter('all')">Alles</button>
            <button class="filter-btn" onclick="setDateFilter('7d')">7 Tage</button>
            <button class="filter-btn" onclick="setDateFilter('30d')">30 Tage</button>
            <button class="filter-btn" onclick="setDateFilter('90d')">90 Tage</button>
            <button class="filter-btn" onclick="setDateFilter('ytd')">YTD</button>
            <button class="filter-btn" onclick="setDateFilter('1y')">1 Jahr</button>
            <div class="custom-date-range">
                <label>Von:</label>
                <input type="date" id="filterStartDate" class="date-input-small" onchange="applyCustomDateFilter()">
                <label>Bis:</label>
                <input type="date" id="filterEndDate" class="date-input-small" onchange="applyCustomDateFilter()">
                <button class="btn btn-primary btn-small" onclick="applyCustomDateFilter()">Anwenden</button>
                <button class="btn btn-danger btn-small" onclick="resetDateFilter()">Zurücksetzen</button>
            </div>
        </div>

        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('dashboard')">📊 Dashboard</button>
            <button class="tab-btn" onclick="switchTab('entry')">📝 Neuer Eintrag</button>
            <button class="tab-btn" onclick="switchTab('cashflow')">💸 Cashflow</button>
            <button class="tab-btn" onclick="switchTab('platforms')">💼 Plattformen</button>
            <button class="tab-btn" onclick="switchTab('history')">📜 Historie</button>
            <button class="tab-btn" onclick="switchTab('settings')">⚙️ Einstellungen</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">💰</div>
                    <div class="stat-label">Portfolio Gesamtwert</div>
                    <div class="stat-value" id="totalValue">$0</div>
                    <div class="stat-change" id="totalChange">
                        <span>📊</span>
                        <span id="totalChangeText">Keine Daten</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📈</div>
                    <div class="stat-label">Performance (Letzte)</div>
                    <div class="stat-value" id="weeklyGrowth">-</div>
                    <div class="stat-change" id="weeklyGrowthAmount">
                        <span>💵</span>
                        <span id="weeklyChangeText">-</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">💎</div>
                    <div class="stat-label">Netto Investiert</div>
                    <div class="stat-value" id="netInvested">$0</div>
                    <div class="stat-change">
                        <span>💳</span>
                        <span id="netInvestedChange">Ein: $0 | Aus: $0</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🏆</div>
                    <div class="stat-label">Reale Performance</div>
                    <div class="stat-value" id="totalProfit">$0</div>
                    <div class="stat-change">
                        <span>📊</span>
                        <span id="profitPercent">0%</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🎯</div>
                    <div class="apr-stat-content">
                        <div class="stat-label">Durchschnitt APR (Auto)</div>
                        <div class="stat-value" id="avgAPR">0%</div>
                        <div class="apr-toggle-switch">
                            <span>Linear</span>
                            <label class="switch">
                                <input type="checkbox" id="aprToggle" onchange="updateAPRDisplay()">
                                <span class="slider"></span>
                            </label>
                            <span>Comp.</span>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">☁️</div>
                    <div class="stat-label">Cloud Sync Status</div>
                    <div class="stat-value" id="cloudSyncStatus">Offline</div>
                    <div class="stat-change">
                        <span>🔄</span>
                        <span id="cloudSyncInfo">Nicht konfiguriert</span>
                    </div>
                </div>
            </div>

            <div class="two-column-layout">
                <div class="section">
                    <div class="section-header">
                        <div class="section-title"><span>📈</span><span>Portfolio Entwicklung</span></div>
                        <div>
                            <select id="chartRange" class="input-field" style="width: 120px; padding: 6px;" onchange="updateChartRange()">
                                <option value="all">Alles</option>
                                <option value="30">30 Tage</option>
                                <option value="90">90 Tage</option>
                                <option value="365">1 Jahr</option>
                            </select>
                            <button class="btn btn-primary btn-small" onclick="downloadChart()"><span>🖼️</span></button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="portfolioChart"></canvas>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <div class="section-title"><span>🍰</span><span>Portfolio-Verteilung</span></div>
                    </div>
                    <div class="chart-container">
                        <canvas id="allocationChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <div class="section-title"><span>⚡</span><span>Plattform Performance</span></div>
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                        <input type="checkbox" id="hideZeroBalance" onchange="updatePlatformSummary()">
                        <span>Nur aktive Positionen</span>
                    </label>
                </div>
                <div class="data-table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="platform">Plattform <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="balance">Balance <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="change">Änderung <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="week">% Änderung <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="apr">APR <span class="sort-arrow"></span></th>
                                <th>Notiz</th>
                            </tr>
                        </thead>
                        <tbody id="platformSummaryBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="entry" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <div class="section-title"><span>📝</span><span>Neuer Eintrag</span></div>
                    <div>
                        <button class="btn btn-success pulse" onclick="saveAllEntries()">
                            <span>💾</span><span>Alle Speichern</span>
                        </button>
                    </div>
                </div>
                
                <div class="date-range-selector">
                    <label style="font-weight: 600;">📅 Datum:</label>
                    <input type="date" id="entryDate" class="date-input">
                    <button class="btn btn-primary btn-small" onclick="setToToday()">Heute</button>
                    <button class="btn btn-primary btn-small" onclick="setToYesterday()">Gestern</button>
                    <button class="btn btn-primary btn-small" onclick="setToLastSunday()">Letzter So</button>
                </div>

                <div style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 16px; color: var(--text-primary);">🦄 Plattformen wählen:</h3>
                    
                    <div class="platform-search-container">
                        <input type="text" id="platformSearch" class="platform-search" placeholder="Plattform suchen..." oninput="filterPlatforms()">
                        <span class="search-icon">🔍</span>
                    </div>
                    
                    <div class="category-filter">
                        <button class="category-btn active" onclick="filterCategory('all')">Alle</button>
                        <button class="category-btn" onclick="filterCategory('Exchange')">Exchanges</button>
                        <button class="category-btn" onclick="filterCategory('DeFi')">DeFi</button>
                        <button class="category-btn" onclick="filterCategory('Lending')">Lending</button>
                        <button class="category-btn" onclick="filterCategory('Wallet')">Wallets</button>
                        <button class="category-btn" onclick="filterCategory('Layer2')">Layer 2</button>
                        <button class="category-btn" onclick="filterCategory('Staking')">Staking</button>
                    </div>
                    
                    <div class="platform-grid" id="platformGrid"></div>
                </div>

                <div id="platformInputs" class="input-grid"></div>
            </div>
        </div>

        <div id="cashflow" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <div class="section-title"><span>💸</span><span>Cashflow Management</span></div>
                </div>
                
                <div class="cashflow-stats">
                    <div class="cashflow-stat">
                        <div class="cashflow-stat-label">➕ Total Eingezahlt</div>
                        <div class="cashflow-stat-value positive" id="totalDeposits">$0,00</div>
                    </div>
                    <div class="cashflow-stat">
                        <div class="cashflow-stat-label">➖ Total Ausgezahlt</div>
                        <div class="cashflow-stat-value negative" id="totalWithdrawals">$0,00</div>
                    </div>
                    <div class="cashflow-stat">
                        <div class="cashflow-stat-label">💎 Netto Investiert</div>
                        <div class="cashflow-stat-value" id="netCashflow">$0,00</div>
                    </div>
                    <div class="cashflow-stat">
                        <div class="cashflow-stat-label">📊 ROI</div>
                        <div class="cashflow-stat-value" id="roiPercent">0.00%</div>
                    </div>
                </div>

                <div class="cashflow-form">
                    <div>
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Typ:</label>
                        <div class="cashflow-type">
                            <label class="radio-option">
                                <input type="radio" name="cashflowType" value="deposit" checked>
                                <span>➕ Einzahlung</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="cashflowType" value="withdraw">
                                <span>➖ Auszahlung</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Betrag (USD):</label>
                        <input type="text" id="cashflowAmount" class="input-field" placeholder="1000" inputmode="decimal">
                    </div>
                    <div>
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Datum:</label>
                        <input type="date" id="cashflowDate" class="date-input">
                    </div>
                    <div id="cashflowTargetDiv">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Ziel-Plattform:</label>
                        <select id="cashflowTarget" class="input-field"></select>
                    </div>
                    <div>
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Notiz:</label>
                        <input type="text" id="cashflowNote" class="input-field" placeholder="Optional...">
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button class="btn btn-success" onclick="saveCashflow()">
                            <span>💾</span><span>Speichern</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <div class="section-title"><span>📜</span><span>Cashflow Historie</span></div>
                </div>
                <div class="data-table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="date">Datum <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="type">Typ <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="amount">Betrag <span class="sort-arrow"></span></th>
                                <th>Plattform</th>
                                <th>Notiz</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="cashflowTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="platforms" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <div class="section-title"><span>💼</span><span>Platform Details</span></div>
                    <div>
                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                        <button class="btn btn-primary btn-small" onclick="document.getElementById('csvFileInput').click()">
                            <span>📤</span> Import CSV
                        </button>
                        <button class="btn btn-primary btn-small" onclick="exportData()">
                            <span>📥</span> Export CSV
                        </button>
                    </div>
                </div>
                <div class="data-table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="platform">Plattform <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="entries">Einträge <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="first">Erster Eintrag <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="last">Letzter Eintrag <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="avg">Avg Balance <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="total">Total Return <span class="sort-arrow"></span></th>
                            </tr>
                        </thead>
                        <tbody id="platformDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="history" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <div class="section-title"><span>📜</span><span>Eintrags-Historie</span></div>
                    <div>
                        <input type="text" id="historySearch" class="input-field" placeholder="Suchen..." style="width: 200px;">
                        <button class="btn btn-danger btn-small" onclick="clearAllData()">
                            <span>🗑️</span> Alle Löschen
                        </button>
                    </div>
                </div>
                <div class="data-table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="date">Datum <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="protocol">Plattform <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="balance">Balance <span class="sort-arrow"></span></th>
                                <th>Notiz</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- New Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="settings-section">
                <h2 style="margin-bottom: 20px;">☁️ Cloud Sync Einstellungen</h2>
                
                <div id="connectionStatus" class="connection-status disconnected">
                    <span>⚠️</span>
                    <span>Nicht verbunden - Konfiguriere GitHub für Cloud Sync</span>
                </div>

                <div class="info-box">
                    <h3>🔐 Wie funktioniert der Cloud Sync?</h3>
                    <p>
                        Deine Daten werden in einem privaten GitHub Gist gespeichert. 
                        Nur du hast Zugriff darauf. Du benötigst einen GitHub Account und ein Personal Access Token.
                    </p>
                </div>

                <div class="settings-grid">
                    <div class="setting-item">
                        <div class="setting-label">GitHub Token</div>
                        <div class="setting-value" id="tokenDisplay">Nicht konfiguriert</div>
                        <div class="setting-actions">
                            <button class="btn btn-primary btn-small" onclick="setupGitHubToken()">Token setzen</button>
                            <button class="btn btn-danger btn-small" onclick="clearGitHubConfig()">Löschen</button>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-label">Gist ID</div>
                        <div class="setting-value" id="gistDisplay">Nicht konfiguriert</div>
                        <div class="setting-actions">
                            <button class="btn btn-primary btn-small" onclick="setupGistId()">Gist ID setzen</button>
                            <button class="btn btn-success btn-small" onclick="createNewGist()">Neu erstellen</button>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">Auto-Sync</div>
                        <div class="setting-value">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="autoSyncToggle" onchange="toggleAutoSync()">
                                <span>Alle 5 Minuten automatisch synchronisieren</span>
                            </label>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">Letzter Sync</div>
                        <div class="setting-value" id="lastSyncDisplay">Noch nie synchronisiert</div>
                        <div class="setting-actions">
                            <button class="btn btn-success btn-small" onclick="syncNow()">Jetzt synchronisieren</button>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" onclick="testConnection()">
                        <span>🔌</span><span>Verbindung testen</span>
                    </button>
                    <button class="btn btn-success" onclick="forceCloudPull()">
                        <span>⬇️</span><span>Cloud → Lokal</span>
                    </button>
                    <button class="btn btn-success" onclick="forceCloudPush()">
                        <span>⬆️</span><span>Lokal → Cloud</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="promptModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="promptModalTitle" class="modal-title">Titel</h2>
            </div>
            <div class="modal-body">
                <p id="promptModalText"></p>
                <input type="text" id="promptModalInput" class="input-field" style="width: 100%; margin-top: 15px; display: none;">
            </div>
            <div class="modal-footer">
                <button id="promptModalCancel" class="btn btn-danger">Abbrechen</button>
                <button id="promptModalOk" class="btn btn-success" style="margin-left: 10px;">OK</button>
            </div>
        </div>
    </div>

    <!-- GitHub Setup Modal -->
    <div id="githubSetupModal" class="github-setup-modal">
        <div class="github-setup-content">
            <div class="github-setup-header">
                <div class="github-setup-title">🔑 GitHub Token Setup</div>
                <p style="color: var(--text-secondary); font-size: 14px;">
                    Gib dein Personal Access Token ein, um Cloud Sync zu aktivieren
                </p>
            </div>
            
            <div class="github-input-group">
                <label>Personal Access Token</label>
                <input type="password" id="githubTokenInput" placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                <div class="github-input-help">
                    <a href="https://github.com/settings/tokens/new?scopes=gist" target="_blank" style="color: var(--primary);">
                        → Token auf GitHub erstellen
                    </a>
                </div>
            </div>

            <div class="github-setup-actions">
                <button class="btn btn-danger" onclick="closeGitHubModal()">Abbrechen</button>
                <button class="btn btn-success" onclick="saveGitHubToken()">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Gist ID Setup Modal -->
    <div id="gistSetupModal" class="github-setup-modal">
        <div class="github-setup-content">
            <div class="github-setup-header">
                <div class="github-setup-title">📝 Gist ID Setup</div>
                <p style="color: var(--text-secondary); font-size: 14px;">
                    Gib die ID deines privaten Gists ein oder erstelle einen neuen
                </p>
            </div>
            
            <div class="github-input-group">
                <label>Gist ID</label>
                <input type="text" id="gistIdInput" placeholder="z.B. a1b2c3d4e5f6g7h8i9j0">
                <div class="github-input-help">
                    Die ID findest du in der URL deines Gists: gist.github.com/username/[DIESE_ID]
                </div>
            </div>

            <div class="github-setup-actions">
                <button class="btn btn-danger" onclick="closeGistModal()">Abbrechen</button>
                <button class="btn btn-success" onclick="saveGistId()">Speichern</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification">
        <span id="notificationIcon">✅</span>
        <span id="notificationText">Gespeichert!</span>
    </div>

    <script>
        // =================================================================================
        // CONFIGURATION & INITIAL DATA
        // =================================================================================
        const DEFAULT_PLATFORMS = [
            // Major Exchanges
            { name: 'Binance', icon: '🏛️', type: 'Exchange', category: 'Exchange' },
            { name: 'Coinbase', icon: '🪙', type: 'Exchange', category: 'Exchange' },
            { name: 'Kraken', icon: '🐙', type: 'Exchange', category: 'Exchange' },
            { name: 'Bybit', icon: '🅱️', type: 'Exchange', category: 'Exchange' },
            { name: 'OKX', icon: '⭕', type: 'Exchange', category: 'Exchange' },
            { name: 'Gate.io', icon: '🚪', type: 'Exchange', category: 'Exchange' },
            { name: 'KuCoin', icon: '🪐', type: 'Exchange', category: 'Exchange' },
            { name: 'Bitget', icon: '🎯', type: 'Exchange', category: 'Exchange' },
            
            // DeFi Protocols
            { name: 'Debank', icon: '📊', type: 'Portfolio', category: 'DeFi' },
            { name: 'Uniswap', icon: '🦄', type: 'DEX', category: 'DeFi' },
            { name: 'PancakeSwap', icon: '🥞', type: 'DEX', category: 'DeFi' },
            { name: 'SushiSwap', icon: '🍣', type: 'DEX', category: 'DeFi' },
            { name: 'Curve', icon: '〰️', type: 'DEX', category: 'DeFi' },
            { name: 'Balancer', icon: '⚖️', type: 'DEX', category: 'DeFi' },
            { name: 'Noble', icon: '⚡', type: 'DeFi', category: 'DeFi' },
            { name: 'Paradex', icon: '🔄', type: 'DEX', category: 'DeFi' },
            { name: 'Pendle', icon: '⏰', type: 'Yield', category: 'DeFi' },
            { name: 'Yearn', icon: '💙', type: 'Yield', category: 'DeFi' },
            
            // Lending Protocols
            { name: 'Aave', icon: '👻', type: 'Lending', category: 'Lending' },
            { name: 'Compound', icon: '💸', type: 'Lending', category: 'Lending' },
            { name: 'MakerDAO', icon: '🔷', type: 'Lending', category: 'Lending' },
            { name: 'Silo', icon: '🌾', type: 'Lending', category: 'Lending' },
            { name: 'Venus', icon: '♀️', type: 'Lending', category: 'Lending' },
            { name: 'JustLend', icon: '🏦', type: 'Lending', category: 'Lending' },
            
            // Perps & Derivatives
            { name: 'Hyperliquid', icon: '💧', type: 'Perps', category: 'DeFi' },
            { name: 'GMX', icon: '🎮', type: 'Perps', category: 'DeFi' },
            { name: 'dYdX', icon: '🔺', type: 'Perps', category: 'DeFi' },
            { name: 'Gains Network', icon: '📈', type: 'Perps', category: 'DeFi' },
            
            // Staking
            { name: 'Lido', icon: '🌊', type: 'Staking', category: 'Staking' },
            { name: 'Rocket Pool', icon: '🚀', type: 'Staking', category: 'Staking' },
            { name: 'Ethereum Staking', icon: '💎', type: 'Staking', category: 'Staking' },
            
            // Layer 2
            { name: 'Arbitrum', icon: '🔵', type: 'Layer 2', category: 'Layer2' },
            { name: 'Optimism', icon: '🔴', type: 'Layer 2', category: 'Layer2' },
            { name: 'Polygon', icon: '🟣', type: 'Layer 2', category: 'Layer2' },
            { name: 'zkSync', icon: '⚡', type: 'Layer 2', category: 'Layer2' },
            
            // Wallets
            { name: 'MetaMask', icon: '🦊', type: 'Wallet', category: 'Wallet' },
            { name: 'Trust Wallet', icon: '🛡️', type: 'Wallet', category: 'Wallet' },
            { name: 'Ledger', icon: '🔒', type: 'Hardware', category: 'Wallet' },
            { name: 'Trezor', icon: '🔐', type: 'Hardware', category: 'Wallet' },
        ];

        // =================================================================================
        // GITHUB SYNC CONFIGURATION
        // =================================================================================
        const GITHUB_API = 'https://api.github.com';
        let githubToken = null;
        let gistId = null;
        let syncInProgress = false;
        let autoSyncInterval = null;
        let lastSyncTime = null;
        let syncStatus = 'offline'; // offline, connected, syncing, error

        // =================================================================================
        // GLOBAL VARIABLES
        // =================================================================================
        let platforms = [];
        let entries = [];
        let cashflows = [];
        let selectedPlatforms = [];
        let portfolioChart, allocationChart;
        let summarySort = { key: 'balance', order: 'desc' };
        let historySort = { key: 'date', order: 'desc' };
        let cashflowSort = { key: 'date', order: 'desc' };
        let platformDetailsSort = { key: 'platform', order: 'asc' };
        let promptResolve = null;
        let currentTheme = 'light';
        let activeCategory = 'all';
        let currentTab = 'dashboard';
        let currentDateFilter = 'all';
        let filteredEntries = [];
        let filteredCashflows = [];
        let searchTerm = '';
        let useCompoundAPR = false;

        // =================================================================================
        // INITIALIZATION
        // =================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            loadGitHubConfig();
            loadData();
            loadTheme();
            setToToday();
            renderPlatformButtons();
            initializeCharts();
            updateDisplay();
            addEventListeners();
            setupPromptModal();
            setupKeyboardShortcuts();
            updateCashflowTargets();
            checkConnectionOnStartup();
        });

        // =================================================================================
        // GITHUB CONFIGURATION & SYNC
        // =================================================================================
        function loadGitHubConfig() {
            githubToken = localStorage.getItem('githubToken');
            gistId = localStorage.getItem('gistId');
            lastSyncTime = localStorage.getItem('lastSyncTime');
            const autoSync = localStorage.getItem('autoSync') === 'true';
            
            if (githubToken) {
                document.getElementById('tokenDisplay').textContent = 'ghp_****' + githubToken.slice(-4);
            }
            
            if (gistId) {
                document.getElementById('gistDisplay').textContent = gistId.slice(0, 8) + '...';
            }
            
            if (lastSyncTime) {
                updateLastSyncDisplay();
            }
            
            document.getElementById('autoSyncToggle').checked = autoSync;
            if (autoSync && githubToken && gistId) {
                startAutoSync();
            }

            updateSyncStatus();
        }

        async function syncNow() {
            if (!githubToken || !gistId) {
                showNotification('Bitte zuerst GitHub konfigurieren', 'error');
                switchTab('settings');
                return;
            }
            
            if (syncInProgress) {
                showNotification('Sync läuft bereits...', 'error');
                return;
            }
            
            syncInProgress = true;
            updateSyncUI('syncing');
            
            try {
                // Get current gist data
                const cloudData = await fetchGistData();
                
                // Get local data
                const localData = {
                    platforms: platforms,
                    entries: entries,
                    cashflows: cashflows,
                    lastSync: new Date().toISOString(),
                    version: '1.0'
                };
                
                // Mark local data as modified
                localStorage.setItem('lastModified', new Date().toISOString());
                
                // Merge strategy: Use newest data
                const mergedData = mergeData(localData, cloudData);
                
                // Save merged data to cloud
                await saveToGist(mergedData);
                
                // Update local data
                platforms = mergedData.platforms;
                entries = mergedData.entries;
                cashflows = mergedData.cashflows;
                saveData();
                
                lastSyncTime = new Date().toISOString();
                localStorage.setItem('lastSyncTime', lastSyncTime);
                updateLastSyncDisplay();
                
                // Refresh display
                applyDateFilter();
                updateDisplay();
                renderPlatformButtons();
                updateCashflowTargets();
                
                showNotification('Erfolgreich synchronisiert! ✨');
                updateSyncUI('connected');
                
            } catch (error) {
                console.error('Sync error:', error);
                showNotification('Sync fehlgeschlagen: ' + error.message, 'error');
                updateSyncUI('error');
            } finally {
                syncInProgress = false;
            }
        }

        async function fetchGistData() {
            const response = await fetch(`${GITHUB_API}/gists/${gistId}`, {
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`GitHub API Error: ${response.status}`);
            }
            
            const gist = await response.json();
            const content = gist.files['portfolio-data.json']?.content;
            
            if (!content) {
                // Create the file if it doesn't exist
                return {
                    platforms: [...DEFAULT_PLATFORMS],
                    entries: [],
                    cashflows: [],
                    lastSync: null,
                    version: '1.0'
                };
            }
            
            return JSON.parse(content);
        }

        async function saveToGist(data) {
            const response = await fetch(`${GITHUB_API}/gists/${gistId}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: {
                        'portfolio-data.json': {
                            content: JSON.stringify(data, null, 2)
                        }
                    }
                })
            });
            
            if (!response.ok) {
                throw new Error(`GitHub API Error: ${response.status}`);
            }
            
            return response.json();
        }

        function mergeData(localData, cloudData) {
            // Advanced merge strategy
            if (!cloudData || !cloudData.lastSync) {
                return localData;
            }
            
            const localTime = new Date(localStorage.getItem('lastModified') || 0);
            const cloudTime = new Date(cloudData.lastSync);
            
            // If cloud is newer, use cloud data
            if (cloudTime > localTime) {
                console.log('Using cloud data (newer)');
                return cloudData;
            } else {
                console.log('Using local data (newer)');
                return localData;
            }
        }

        async function forceCloudPull() {
            if (!githubToken || !gistId) {
                showNotification('Bitte zuerst GitHub konfigurieren', 'error');
                return;
            }
            
            const confirmed = await showCustomPrompt({
                title: '⬇️ Cloud Daten übernehmen',
                text: 'Lokale Daten werden mit Cloud-Daten überschrieben. Fortfahren?',
                showInput: false
            });
            
            if (!confirmed) return;
            
            try {
                const cloudData = await fetchGistData();
                platforms = cloudData.platforms || [...DEFAULT_PLATFORMS];
                entries = cloudData.entries || [];
                cashflows = cloudData.cashflows || [];
                saveData();
                applyDateFilter();
                updateDisplay();
                renderPlatformButtons();
                updateCashflowTargets();
                showNotification('Cloud-Daten übernommen! ✅');
            } catch (error) {
                showNotification('Fehler beim Laden: ' + error.message, 'error');
            }
        }

        async function forceCloudPush() {
            if (!githubToken || !gistId) {
                showNotification('Bitte zuerst GitHub konfigurieren', 'error');
                return;
            }
            
            const confirmed = await showCustomPrompt({
                title: '⬆️ Lokale Daten hochladen',
                text: 'Cloud-Daten werden mit lokalen Daten überschrieben. Fortfahren?',
                showInput: false
            });
            
            if (!confirmed) return;
            
            try {
                const localData = {
                    platforms: platforms,
                    entries: entries,
                    cashflows: cashflows,
                    lastSync: new Date().toISOString(),
                    version: '1.0'
                };
                await saveToGist(localData);
                showNotification('Lokale Daten hochgeladen! ✅');
            } catch (error) {
                showNotification('Upload fehlgeschlagen: ' + error.message, 'error');
            }
        }

        // Cloud settings UI functions
        function openCloudSettings() {
            switchTab('settings');
        }

        function setupGitHubToken() {
            document.getElementById('githubSetupModal').classList.add('visible');
            document.getElementById('githubTokenInput').focus();
        }

        function setupGistId() {
            document.getElementById('gistSetupModal').classList.add('visible');
            document.getElementById('gistIdInput').focus();
        }

        function closeGitHubModal() {
            document.getElementById('githubSetupModal').classList.remove('visible');
        }

        function closeGistModal() {
            document.getElementById('gistSetupModal').classList.remove('visible');
        }

        function saveGitHubToken() {
            const token = document.getElementById('githubTokenInput').value.trim();
            if (!token) {
                showNotification('Bitte Token eingeben', 'error');
                return;
            }
            
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                showNotification('Ungültiges Token Format', 'error');
                return;
            }
            
            githubToken = token;
            localStorage.setItem('githubToken', token);
            document.getElementById('tokenDisplay').textContent = 'ghp_****' + token.slice(-4);
            document.getElementById('githubTokenInput').value = '';
            closeGitHubModal();
            showNotification('Token gespeichert!');
            updateSyncStatus();
            testConnection();
        }

        function saveGistId() {
            const id = document.getElementById('gistIdInput').value.trim();
            if (!id) {
                showNotification('Bitte Gist ID eingeben', 'error');
                return;
            }
            
            gistId = id;
            localStorage.setItem('gistId', id);
            document.getElementById('gistDisplay').textContent = id.slice(0, 8) + '...';
            document.getElementById('gistIdInput').value = '';
            closeGistModal();
            showNotification('Gist ID gespeichert!');
            updateSyncStatus();
            testConnection();
        }

        async function createNewGist() {
            if (!githubToken) {
                showNotification('Bitte zuerst GitHub Token konfigurieren', 'error');
                setupGitHubToken();
                return;
            }
            
            try {
                showNotification('Erstelle neuen Gist...');
                
                const response = await fetch(`${GITHUB_API}/gists`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: 'Web3 Portfolio Tracker Data',
                        public: false,
                        files: {
                            'portfolio-data.json': {
                                content: JSON.stringify({
                                    platforms: platforms,
                                    entries: entries,
                                    cashflows: cashflows,
                                    lastSync: new Date().toISOString(),
                                    version: '1.0'
                                }, null, 2)
                            }
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API Error: ${response.status}`);
                }
                
                const gist = await response.json();
                gistId = gist.id;
                localStorage.setItem('gistId', gistId);
                document.getElementById('gistDisplay').textContent = gistId.slice(0, 8) + '...';
                
                showNotification('Neuer Gist erstellt! 🎉');
                updateSyncStatus();
                
                // Initial sync
                await syncNow();
                
            } catch (error) {
                console.error('Error creating gist:', error);
                showNotification('Fehler beim Erstellen des Gists', 'error');
            }
        }

        function clearGitHubConfig() {
            if (confirm('Wirklich alle GitHub Einstellungen löschen?')) {
                localStorage.removeItem('githubToken');
                localStorage.removeItem('gistId');
                localStorage.removeItem('lastSyncTime');
                localStorage.removeItem('autoSync');
                
                githubToken = null;
                gistId = null;
                lastSyncTime = null;
                stopAutoSync();
                
                document.getElementById('tokenDisplay').textContent = 'Nicht konfiguriert';
                document.getElementById('gistDisplay').textContent = 'Nicht konfiguriert';
                document.getElementById('lastSyncDisplay').textContent = 'Noch nie synchronisiert';
                document.getElementById('autoSyncToggle').checked = false;
                
                updateSyncStatus();
                showNotification('GitHub Konfiguration gelöscht');
            }
        }

        async function testConnection() {
            if (!githubToken || !gistId) {
                showNotification('Bitte Token und Gist ID konfigurieren', 'error');
                return;
            }
            
            try {
                showNotification('Teste Verbindung...');
                await fetchGistData();
                
                document.getElementById('connectionStatus').className = 'connection-status connected';
                document.getElementById('connectionStatus').innerHTML = `
                    <span>✅</span>
                    <span>Erfolgreich verbunden mit GitHub!</span>
                `;
                
                showNotification('Verbindung erfolgreich! ✅');
                updateSyncStatus();
                
            } catch (error) {
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
                document.getElementById('connectionStatus').innerHTML = `
                    <span>❌</span>
                    <span>Verbindungsfehler: ${error.message}</span>
                `;
                
                showNotification('Verbindung fehlgeschlagen', 'error');
            }
        }

        async function checkConnectionOnStartup() {
            if (githubToken && gistId) {
                try {
                    await fetchGistData();
                    updateSyncUI('connected');
                    // Auto sync on startup if needed
                    const autoSync = localStorage.getItem('autoSync') === 'true';
                    if (autoSync) {
                        setTimeout(() => syncNow(), 2000);
                    }
                } catch (error) {
                    updateSyncUI('error');
                }
            }
        }

        function toggleAutoSync() {
            const enabled = document.getElementById('autoSyncToggle').checked;
            localStorage.setItem('autoSync', enabled);
            
            if (enabled) {
                startAutoSync();
                showNotification('Auto-Sync aktiviert');
            } else {
                stopAutoSync();
                showNotification('Auto-Sync deaktiviert');
            }
        }

        function startAutoSync() {
            stopAutoSync();
            autoSyncInterval = setInterval(() => {
                syncNow();
            }, 5 * 60 * 1000);
        }

        function stopAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }
        }

        function updateSyncStatus() {
            const hasConfig = githubToken && gistId;
            
            if (hasConfig) {
                syncStatus = 'connected';
                document.getElementById('cloudStatusBadge').className = 'cloud-status-badge';
                document.getElementById('cloudIcon').textContent = '☁️';
                document.getElementById('cloudText').textContent = 'Cloud Sync';
                document.getElementById('cloudSyncStatus').textContent = 'Verbunden';
                document.getElementById('cloudSyncInfo').textContent = 'GitHub Gist';
            } else {
                syncStatus = 'offline';
                document.getElementById('cloudStatusBadge').className = 'cloud-status-badge disconnected';
                document.getElementById('cloudIcon').textContent = '🔌';
                document.getElementById('cloudText').textContent = 'Offline';
                document.getElementById('cloudSyncStatus').textContent = 'Offline';
                document.getElementById('cloudSyncInfo').textContent = 'Nicht konfiguriert';
            }
            
            updateSyncBar();
        }

        function updateSyncUI(status) {
            const indicator = document.getElementById('syncIndicator');
            const statusText = document.getElementById('syncStatusText');
            const syncBtn = document.getElementById('syncNowBtn');
            const syncBtnIcon = document.getElementById('syncBtnIcon');
            const syncBtnText = document.getElementById('syncBtnText');
            const cloudBadge = document.getElementById('cloudStatusBadge');
            
            switch(status) {
                case 'syncing':
                    indicator.className = 'sync-indicator pending';
                    statusText.textContent = 'Synchronisiere...';
                    syncBtnIcon.innerHTML = '<span class="spinner"></span>';
                    syncBtnText.textContent = 'Syncing...';
                    syncBtn.disabled = true;
                    cloudBadge.className = 'cloud-status-badge syncing';
                    document.getElementById('cloudText').textContent = 'Syncing...';
                    showSyncBar();
                    break;
                    
                case 'connected':
                    indicator.className = 'sync-indicator synced';
                    statusText.textContent = 'Synchronisiert';
                    syncBtnIcon.textContent = '✅';
                    syncBtnText.textContent = 'Sync';
                    syncBtn.disabled = false;
                    cloudBadge.className = 'cloud-status-badge';
                    document.getElementById('cloudText').textContent = 'Synced';
                    setTimeout(() => {
                        document.getElementById('cloudText').textContent = 'Cloud Sync';
                        hideSyncBar();
                    }, 3000);
                    break;
                    
                case 'error':
                    indicator.className = 'sync-indicator error';
                    statusText.textContent = 'Sync Fehler';
                    syncBtnIcon.textContent = '⚠️';
                    syncBtnText.textContent = 'Retry';
                    syncBtn.disabled = false;
                    cloudBadge.className = 'cloud-status-badge error';
                    document.getElementById('cloudText').textContent = 'Error';
                    showSyncBar();
                    break;
                    
                default:
                    indicator.className = 'sync-indicator offline';
                    statusText.textContent = 'Offline Modus';
                    syncBtnIcon.textContent = '☁️';
                    syncBtnText.textContent = 'Sync';
                    syncBtn.disabled = !githubToken || !gistId;
            }
        }

        function updateSyncBar() {
            const bar = document.getElementById('syncStatusBar');
            if (githubToken && gistId) {
                bar.classList.add('visible');
                document.body.classList.add('has-sync-bar');
            } else {
                document.body.classList.remove('has-sync-bar');
            }
        }

        function showSyncBar() {
            document.getElementById('syncStatusBar').classList.add('visible');
            document.body.classList.add('has-sync-bar');
        }

        function hideSyncBar() {
            if (!syncInProgress) {
                document.getElementById('syncStatusBar').classList.remove('visible');
                setTimeout(() => {
                    if (!syncInProgress) {
                        document.body.classList.remove('has-sync-bar');
                    }
                }, 300);
            }
        }

        function toggleSyncBar() {
            const bar = document.getElementById('syncStatusBar');
            if (bar.classList.contains('visible')) {
                hideSyncBar();
            } else {
                showSyncBar();
            }
        }

        function updateLastSyncDisplay() {
            if (!lastSyncTime) return;
            
            const lastSync = new Date(lastSyncTime);
            const now = new Date();
            const diffMs = now - lastSync;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            let timeText;
            if (diffMins < 1) {
                timeText = 'Gerade eben';
            } else if (diffMins < 60) {
                timeText = `Vor ${diffMins} Minute${diffMins !== 1 ? 'n' : ''}`;
            } else if (diffHours < 24) {
                timeText = `Vor ${diffHours} Stunde${diffHours !== 1 ? 'n' : ''}`;
            } else {
                timeText = `Vor ${diffDays} Tag${diffDays !== 1 ? 'en' : ''}`;
            }
            
            document.getElementById('lastSyncDisplay').textContent = timeText;
            document.getElementById('lastSyncTime').textContent = timeText;
        }

        // =================================================================================
        // Continue with all other functions from the original app...
        // =================================================================================
        
        function addEventListeners() {
            // Smart Save - only save current field on Enter
            document.addEventListener('keydown', (e) => {
                if (e.target.classList.contains('input-field') && e.target.dataset.platform) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveSingleEntry(e.target);
                    }
                }
            });

            // Global Save with Ctrl/Cmd + S
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (currentTab === 'entry') {
                        saveAllEntries();
                    } else if (currentTab === 'cashflow') {
                        saveCashflow();
                    } else {
                        syncNow();
                    }
                }
            });

            // Sort listeners
            document.querySelectorAll('.data-table th.sortable').forEach(th => {
                th.addEventListener('click', handleSort);
            });

            // CSV Import
            document.getElementById('csvFileInput').addEventListener('change', handleCsvImport);

            // History Search
            const searchInput = document.getElementById('historySearch');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    updateHistory(e.target.value);
                });
            }

            // Cashflow Type Radio Change
            document.querySelectorAll('input[name="cashflowType"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const targetDiv = document.getElementById('cashflowTargetDiv');
                    if (e.target.value === 'deposit') {
                        targetDiv.style.display = 'block';
                    } else {
                        targetDiv.style.display = 'none';
                    }
                });
            });

            // Set cashflow date to today on tab switch
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.textContent.includes('Cashflow')) {
                        const today = new Date().toISOString().split('T')[0];
                        document.getElementById('cashflowDate').value = today;
                    }
                });
            });
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Alt + Number to switch tabs
                if (e.altKey) {
                    switch(e.key) {
                        case '1': switchTab('dashboard'); break;
                        case '2': switchTab('entry'); break;
                        case '3': switchTab('cashflow'); break;
                        case '4': switchTab('platforms'); break;
                        case '5': switchTab('history'); break;
                        case '6': switchTab('settings'); break;
                    }
                }
                
                // Ctrl/Cmd + D for dark mode
                if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                    e.preventDefault();
                    toggleTheme();
                }
                
                // Ctrl/Cmd + , for settings
                if ((e.ctrlKey || e.metaKey) && e.key === ',') {
                    e.preventDefault();
                    switchTab('settings');
                }
                
                // Escape to close modals
                if (e.key === 'Escape') {
                    document.getElementById('githubSetupModal').classList.remove('visible');
                    document.getElementById('gistSetupModal').classList.remove('visible');
                    document.getElementById('promptModal').classList.remove('visible');
                }
            });
        }

        // =================================================================================
        // DATA HANDLING
        // =================================================================================
        function loadData() {
            platforms = JSON.parse(localStorage.getItem('portfolioPlatforms_v10')) || [...DEFAULT_PLATFORMS];
            entries = JSON.parse(localStorage.getItem('portfolioEntries_v10')) || [];
            cashflows = JSON.parse(localStorage.getItem('portfolioCashflows_v10')) || [];
            
            filteredEntries = [...entries];
            filteredCashflows = [...cashflows];
        }

        function saveData() {
            localStorage.setItem('portfolioPlatforms_v10', JSON.stringify(platforms));
            localStorage.setItem('portfolioEntries_v10', JSON.stringify(entries));
            localStorage.setItem('portfolioCashflows_v10', JSON.stringify(cashflows));
            localStorage.setItem('lastModified', new Date().toISOString());
            
            // Auto sync if configured
            if (githubToken && gistId && localStorage.getItem('autoSync') === 'true') {
                // Debounce auto sync
                clearTimeout(window.autoSyncTimeout);
                window.autoSyncTimeout = setTimeout(() => {
                    syncNow();
                }, 5000);
            }
        }

        function savePlatforms() {
            localStorage.setItem('portfolioPlatforms_v10', JSON.stringify(platforms));
        }

        function saveSingleEntry(inputElement) {
            const date = document.getElementById('entryDate').value;
            if (!date) {
                showNotification('Bitte Datum wählen!', 'error');
                return;
            }
            
            const platformName = inputElement.dataset.platform;
            const inputId = platformName.replace(/\s+/g, '_');
            const balance = parseFloat(inputElement.value.replace(',', '.'));
            const note = document.getElementById(`note_${inputId}`)?.value || '';
            
            if (!inputElement.value || isNaN(balance)) {
                return;
            }
            
            entries = entries.filter(e => !(e.date === date && e.protocol === platformName));
            
            entries.push({
                id: Date.now() + Math.random(),
                date: date,
                protocol: platformName,
                balance: balance,
                note: note
            });
            
            saveData();
            applyDateFilter();
            updateDisplay();
            
            inputElement.value = '';
            inputElement.placeholder = `Letzter: $${balance.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            showNotification(`${platformName} gespeichert!`);
            
            const allInputs = Array.from(document.querySelectorAll('#platformInputs .input-field[data-platform]'));
            const currentIndex = allInputs.indexOf(inputElement);
            if (currentIndex < allInputs.length - 1) {
                allInputs[currentIndex + 1].focus();
            }
        }

        function saveAllEntries() {
            const date = document.getElementById('entryDate').value;
            if (!date) {
                showNotification('Bitte Datum wählen!', 'error');
                return;
            }
            
            let newEntriesCount = 0;
            selectedPlatforms.forEach(platformName => {
                const inputId = platformName.replace(/\s+/g, '_');
                const balanceInput = document.getElementById(`balance_${inputId}`);
                const noteInput = document.getElementById(`note_${inputId}`);

                if (balanceInput && balanceInput.value) {
                    const balance = parseFloat(balanceInput.value.replace(',', '.'));
                    if (isNaN(balance)) return;

                    entries = entries.filter(e => !(e.date === date && e.protocol === platformName));
                    
                    entries.push({
                        id: Date.now() + Math.random(),
                        date: date,
                        protocol: platformName,
                        balance: balance,
                        note: noteInput?.value || ''
                    });
                    newEntriesCount++;
                }
            });
            
            if (newEntriesCount === 0) {
                showNotification('Keine Daten zum Speichern!', 'error');
                return;
            }
            
            saveData();
            applyDateFilter();
            
            document.getElementById('platformInputs').innerHTML = '';
            document.querySelectorAll('.platform-btn.selected').forEach(btn => btn.classList.remove('selected'));
            selectedPlatforms = [];
            
            updateDisplay();
            showNotification(`${newEntriesCount} Einträge gespeichert!`);
        }

        function saveCashflow() {
            const type = document.querySelector('input[name="cashflowType"]:checked')?.value;
            const amount = parseFloat(document.getElementById('cashflowAmount').value.replace(',', '.'));
            const date = document.getElementById('cashflowDate').value;
            const target = document.getElementById('cashflowTarget').value;
            const note = document.getElementById('cashflowNote').value;

            if (!type || !amount || isNaN(amount) || !date) {
                showNotification('Bitte alle Pflichtfelder ausfüllen!', 'error');
                return;
            }

            const cashflow = {
                id: Date.now() + Math.random(),
                type: type,
                amount: amount,
                date: date,
                platform: type === 'deposit' ? (target || 'Portfolio') : 'Portfolio',
                note: note
            };

            cashflows.push(cashflow);
            saveData();
            applyDateFilter();
            
            document.getElementById('cashflowAmount').value = '';
            document.getElementById('cashflowNote').value = '';
            document.querySelector('input[name="cashflowType"][value="deposit"]').checked = true;
            document.getElementById('cashflowTargetDiv').style.display = 'block';
            
            updateDisplay();
            showNotification(`${type === 'deposit' ? 'Einzahlung' : 'Auszahlung'} gespeichert!`);
        }

        async function deleteCashflow(cashflowId) {
            const cashflow = cashflows.find(c => c.id == cashflowId);
            if (!cashflow) return;
            
            const confirmed = await showCustomPrompt({
                title: 'Cashflow löschen',
                text: `${formatDate(cashflow.date)} - $${cashflow.amount} löschen?`,
                showInput: false
            });

            if(confirmed) {
                cashflows = cashflows.filter(c => c.id != cashflowId);
                saveData();
                applyDateFilter();
                updateDisplay();
                showNotification('Cashflow gelöscht!');
            }
        }

        async function deleteEntry(entryId) {
            const entry = entries.find(e => e.id == entryId);
            if (!entry) return;
            
            const confirmed = await showCustomPrompt({
                title: 'Eintrag löschen',
                text: `${formatDate(entry.date)} - ${entry.protocol} löschen?`,
                showInput: false
            });

            if(confirmed) {
                entries = entries.filter(e => e.id != entryId);
                saveData();
                applyDateFilter();
                updateDisplay();
                showNotification('Eintrag gelöscht!');
            }
        }

        async function clearAllData() {
            const confirmation = await showCustomPrompt({
                title: '⚠️ Alle Daten löschen',
                text: 'WARNUNG: Alle Einträge und Cashflows werden gelöscht! "DELETE ALL" eingeben.',
                showInput: true
            });

            if (confirmation && confirmation === 'DELETE ALL') {
                entries = [];
                cashflows = [];
                filteredEntries = [];
                filteredCashflows = [];
                saveData();
                updateDisplay();
                showNotification('Alle Daten gelöscht!');
            }
        }

        // =================================================================================
        // Include all other functions from original app
        // (Date filters, Tab management, Theme, Platform management, Display updates, 
        //  Charts, CSV handling, PDF export, Helper functions, etc.)
        // =================================================================================
        
        // DATE FILTER FUNCTIONS
        function setDateFilter(period) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const endDate = new Date();
            let startDate = new Date();
            
            switch(period) {
                case '7d':
                    startDate.setDate(endDate.getDate() - 7);
                    break;
                case '30d':
                    startDate.setDate(endDate.getDate() - 30);
                    break;
                case '90d':
                    startDate.setDate(endDate.getDate() - 90);
                    break;
                case 'ytd':
                    startDate = new Date(endDate.getFullYear(), 0, 1);
                    break;
                case '1y':
                    startDate.setFullYear(endDate.getFullYear() - 1);
                    break;
                case 'all':
                default:
                    currentDateFilter = 'all';
                    applyDateFilter();
                    return;
            }
            
            currentDateFilter = period;
            document.getElementById('filterStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('filterEndDate').value = endDate.toISOString().split('T')[0];
            applyDateFilter();
        }

        function applyCustomDateFilter() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (!startDate || !endDate) {
                showNotification('Bitte beide Daten auswählen', 'error');
                return;
            }
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            currentDateFilter = 'custom';
            applyDateFilter();
        }

        function resetDateFilter() {
            currentDateFilter = 'all';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === 'Alles') {
                    btn.classList.add('active');
                }
            });
            
            applyDateFilter();
        }

        function applyDateFilter() {
            if (currentDateFilter === 'all') {
                filteredEntries = [...entries];
                filteredCashflows = [...cashflows];
            } else {
                const startDate = new Date(document.getElementById('filterStartDate').value);
                const endDate = new Date(document.getElementById('filterEndDate').value);
                endDate.setHours(23, 59, 59, 999);
                
                filteredEntries = entries.filter(e => {
                    const entryDate = new Date(e.date);
                    return entryDate >= startDate && entryDate <= endDate;
                });
                
                filteredCashflows = cashflows.filter(c => {
                    const cashflowDate = new Date(c.date);
                    return cashflowDate >= startDate && cashflowDate <= endDate;
                });
            }
            
            updateDisplay();
        }

        // TAB MANAGEMENT
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            
            const tabBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn => 
                btn.onclick.toString().includes(tabName)
            );
            if (tabBtn) {
                tabBtn.classList.add('active');
            }
            
            currentTab = tabName;
            
            if (tabName === 'platforms') {
                updatePlatformDetails();
            } else if (tabName === 'cashflow') {
                updateCashflowDisplay();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('cashflowDate').value = today;
            }
        }

        // THEME MANAGEMENT
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.classList.toggle('dark-mode');
            document.querySelector('.theme-toggle').textContent = currentTheme === 'light' ? '🌙' : '☀️';
            localStorage.setItem('theme', currentTheme);
            updateChartTheme();
        }

        function loadTheme() {
            currentTheme = localStorage.getItem('theme') || 'light';
            if (currentTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.querySelector('.theme-toggle').textContent = '☀️';
            }
        }

        function updateChartTheme() {
            const textColor = currentTheme === 'dark' ? '#f9fafb' : '#1f2937';
            const gridColor = currentTheme === 'dark' ? '#374151' : '#e5e7eb';
            
            [portfolioChart, allocationChart].forEach(chart => {
                if (chart) {
                    if (chart.options.scales?.y) {
                        chart.options.scales.y.ticks.color = textColor;
                        chart.options.scales.y.grid.color = gridColor;
                    }
                    if (chart.options.scales?.x) {
                        chart.options.scales.x.ticks.color = textColor;
                        chart.options.scales.x.grid.color = gridColor;
                    }
                    if (chart.options.plugins?.legend?.labels) {
                        chart.options.plugins.legend.labels.color = textColor;
                    }
                    chart.update();
                }
            });
        }

        // PLATFORM MANAGEMENT
        function filterPlatforms() {
            searchTerm = document.getElementById('platformSearch').value.toLowerCase();
            renderPlatformButtons();
        }

        function renderPlatformButtons() {
            const grid = document.getElementById('platformGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            let filteredPlatforms = platforms;
            
            if (activeCategory !== 'all') {
                filteredPlatforms = filteredPlatforms.filter(p => p.category === activeCategory);
            }
            
            if (searchTerm) {
                filteredPlatforms = filteredPlatforms.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    p.type.toLowerCase().includes(searchTerm) ||
                    p.category.toLowerCase().includes(searchTerm)
                );
            }
            
            filteredPlatforms.forEach(p => {
                const tile = document.createElement('div');
                tile.className = 'platform-btn';
                tile.draggable = true;
                
                if (selectedPlatforms.includes(p.name)) {
                    tile.classList.add('selected');
                }
                
                tile.onclick = () => togglePlatform(tile, p.name);
                
                tile.ondragstart = (e) => {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', p.name);
                    tile.classList.add('dragging');
                };
                
                tile.ondragend = () => {
                    tile.classList.remove('dragging');
                };

                tile.innerHTML = `
                    <div class="remove-tile" title="Plattform entfernen" onclick="event.stopPropagation(); deletePlatform('${p.name}')">×</div>
                    <div class="icon">${p.icon}</div>
                    <div class="name">${p.name}</div>
                    <div class="type">${p.type}</div>
                `;
                grid.appendChild(tile);
            });

            const addTile = document.createElement('div');
            addTile.className = 'platform-btn';
            addTile.onclick = addCustomPlatform;
            addTile.innerHTML = `
                <div class="icon">➕</div>
                <div class="name">Andere</div>
                <div class="type">Hinzufügen</div>
            `;
            grid.appendChild(addTile);
        }

        function filterCategory(category) {
            activeCategory = category;
            searchTerm = '';
            document.getElementById('platformSearch').value = '';
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.onclick.toString().includes(category)) {
                    btn.classList.add('active');
                }
            });
            
            renderPlatformButtons();
        }
        
        async function resetPlatforms() {
            const confirmation = await showCustomPrompt({
                title: 'Plattformen zurücksetzen',
                text: 'Dadurch wird Ihre benutzerdefinierte Plattformliste gelöscht. Geben Sie "reset" ein.',
                showInput: true
            });

            if (confirmation && confirmation.toLowerCase() === 'reset') {
                platforms = [...DEFAULT_PLATFORMS];
                savePlatforms();
                renderPlatformButtons();
                updateCashflowTargets();
                showNotification('Plattformen wurden zurückgesetzt!');
            }
        }

        async function deletePlatform(platformName) {
            const confirmed = await showCustomPrompt({
                title: 'Plattform löschen',
                text: `'${platformName}' wirklich entfernen?`,
                showInput: false
            });

            if (confirmed) {
                platforms = platforms.filter(p => p.name !== platformName);
                savePlatforms();
                
                if (selectedPlatforms.includes(platformName)) {
                    removePlatformInput(platformName);
                }

                renderPlatformButtons();
                updateCashflowTargets();
            }
        }
        
        function togglePlatform(element, platformName) {
            element.classList.toggle('selected');
            
            if (element.classList.contains('selected')) {
                if (!selectedPlatforms.includes(platformName)) {
                    selectedPlatforms.push(platformName);
                    addPlatformInput(platformName);
                }
            } else {
                selectedPlatforms = selectedPlatforms.filter(p => p !== platformName);
                removePlatformInput(platformName);
            }
        }

        async function addCustomPlatform() {
            const name = await showCustomPrompt({
                title: 'Neue Plattform',
                text: 'Name der Plattform:',
                showInput: true
            });

            if (!name || !name.trim()) return;

            if (platforms.some(p => p.name.toLowerCase() === name.trim().toLowerCase())) {
                showNotification('Plattform existiert bereits!', 'error');
                return;
            }

            const type = await showCustomPrompt({
                title: 'Plattform Typ',
                text: `Typ für "${name.trim()}"? (z.B. DEX, Lending)`,
                showInput: true
            });

            const category = await showCustomPrompt({
                title: 'Kategorie',
                text: 'Exchange, DeFi, Lending, Wallet, Layer2, Staking oder Custom?',
                showInput: true
            });

            const newPlatform = { 
                name: name.trim(), 
                type: type ? type.trim() : 'Custom',
                category: category ? category.trim() : 'Custom',
                icon: getAutoIcon(name.trim(), type ? type.trim() : '')
            };
            
            platforms.push(newPlatform);
            savePlatforms();
            renderPlatformButtons();
            updateCashflowTargets();
            showNotification(`${name.trim()} hinzugefügt!`);
        }

        function getAutoIcon(name, type) {
            const lowerType = type.toLowerCase();
            const lowerName = name.toLowerCase();
            const iconMap = {
                'dex': '🔄', 'exchange': '🏛️', 'lending': '🤝', 'yield': '⏰', 
                'liquid': '💧', 'wallet': '🦊', 'portfolio': '📊', 'perps': '📈',
                'bridge': '🌉', 'staking': '🔒', 'nft': '🎨', 'gaming': '🎮',
                'layer': '🔷', 'farm': '🌾', 'vault': '🏦', 'options': '📊'
            };

            for (const key in iconMap) {
                if (lowerType.includes(key) || lowerName.includes(key)) {
                    return iconMap[key];
                }
            }
            return '💎';
        }

        function addPlatformInput(platformName) {
            const container = document.getElementById('platformInputs');
            if (!container) return;
            
            const inputId = platformName.replace(/\s+/g, '_');
            
            if (document.getElementById(`input_${inputId}`)) return;
            
            const lastEntry = getLastEntryForPlatform(platformName);
            const lastValue = lastEntry ? lastEntry.balance.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '';
            
            const div = document.createElement('div');
            div.id = `input_${inputId}`;
            div.className = 'input-card';
            
            div.innerHTML = `
                <div class="input-row">
                    <div class="platform-name tooltip">
                        ${platformName}
                        <span class="tooltiptext">Enter zum Speichern, Tab für nächstes Feld</span>
                    </div>
                    <input type="text" 
                        inputmode="decimal" 
                        id="balance_${inputId}" 
                        class="input-field" 
                        placeholder="${lastValue ? 'Letzter: ' + lastValue : 'Balance in USD'}"
                        data-platform="${platformName}">
                    <input type="text" 
                        id="note_${inputId}" 
                        class="note-input" 
                        placeholder="Notiz..."
                        data-platform="${platformName}">
                    ${lastValue ? `<div class="last-value">${lastValue}</div>` : '<div></div>'}
                    <button class="remove-btn" onclick="removePlatformInput('${platformName}')">✕</button>
                </div>
            `;
            container.appendChild(div);
            
            setTimeout(() => {
                document.getElementById(`balance_${inputId}`).focus();
            }, 100);
        }

        function removePlatformInput(platformName) {
            const inputId = platformName.replace(/\s+/g, '_');
            const element = document.getElementById(`input_${inputId}`);
            if (element) element.remove();
            
            selectedPlatforms = selectedPlatforms.filter(p => p !== platformName);

            const button = Array.from(document.querySelectorAll('.platform-btn')).find(
                btn => btn.querySelector('.name')?.textContent === platformName
            );
            if (button) {
                button.classList.remove('selected');
            }
        }

        // DISPLAY UPDATES
        function updateDisplay() {
            updateStats();
            updatePlatformSummary();
            updateHistory();
            updateCharts();
            updateCashflowDisplay();
            updateAPRDisplay();
        }

        function updateStats() {
            const adjustedData = calculateAdjustedBalances();
            
            if (adjustedData.totalBalance === 0 && filteredEntries.length === 0) {
                document.getElementById('totalValue').textContent = '$0';
                document.getElementById('totalChangeText').textContent = 'Keine Daten';
                document.getElementById('weeklyGrowth').textContent = '-';
                document.getElementById('weeklyChangeText').textContent = '-';
            } else {
                document.getElementById('totalValue').textContent = `${adjustedData.totalBalance.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                
                const dateGroups = filteredEntries.reduce((acc, entry) => {
                    acc[entry.date] = (acc[entry.date] || 0) + entry.balance;
                    return acc;
                }, {});
                
                const sortedDates = Object.keys(dateGroups).sort((a, b) => new Date(a) - new Date(b));
                
                if (sortedDates.length > 1) {
                    const currentTotal = dateGroups[sortedDates[sortedDates.length - 1]];
                    const previousTotal = dateGroups[sortedDates[sortedDates.length - 2]];
                    const change = currentTotal - previousTotal;
                    const changePercent = (previousTotal !== 0) ? (change / previousTotal * 100) : 0;
                    
                    const changeText = document.getElementById('totalChangeText');
                    changeText.textContent = `${change >= 0 ? '+' : ''}${change.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${changePercent.toFixed(2)}%)`;
                    changeText.className = change >= 0 ? 'positive' : 'negative';
                    
                    const weeklyGrowth = document.getElementById('weeklyGrowth');
                    weeklyGrowth.textContent = `${change >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
                    weeklyGrowth.className = change >= 0 ? 'positive' : 'negative';

                    const weeklyChangeText = document.getElementById('weeklyChangeText');
                    weeklyChangeText.textContent = `${change >= 0 ? '+' : ''}${change.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    weeklyChangeText.className = change >= 0 ? 'positive' : 'negative';
                }
            }
            
            document.getElementById('netInvested').textContent = `${adjustedData.netInvested.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('netInvestedChange').textContent = `Ein: ${adjustedData.totalDeposits.toLocaleString('de-DE', {minimumFractionDigits: 0})} | Aus: ${adjustedData.totalWithdrawals.toLocaleString('de-DE', {minimumFractionDigits: 0})}`;
            
            const profit = adjustedData.totalBalance - adjustedData.netInvested;
            const profitPercent = adjustedData.netInvested !== 0 ? (profit / adjustedData.netInvested * 100) : 0;
            
            document.getElementById('totalProfit').textContent = `${profit.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('profitPercent').textContent = `${profitPercent.toFixed(2)}% ROI`;
        }

        function updateAPRDisplay() {
            useCompoundAPR = document.getElementById('aprToggle')?.checked || false;
            
            const platformData = filteredEntries.reduce((acc, entry) => {
                if (!acc[entry.protocol]) acc[entry.protocol] = [];
                acc[entry.protocol].push(entry);
                return acc;
            }, {});
            
            let totalAPR = 0;
            let platformCount = 0;
            
            Object.keys(platformData).forEach(platform => {
                const pEntries = platformData[platform].sort((a, b) => new Date(a.date) - new Date(b.date));
                if (pEntries.length > 1) {
                    const current = pEntries[pEntries.length - 1];
                    const previous = pEntries[pEntries.length - 2];
                    
                    if (previous.balance !== 0) {
                        const daysDiff = (new Date(current.date) - new Date(previous.date)) / (1000 * 60 * 60 * 24);
                        const apr = calculateAPR(current.balance, previous.balance, daysDiff, useCompoundAPR);
                        if (isFinite(apr)) {
                            totalAPR += apr;
                            platformCount++;
                        }
                    }
                }
            });
            
            const avgAPR = platformCount > 0 ? totalAPR / platformCount : 0;
            document.getElementById('avgAPR').textContent = `${avgAPR.toFixed(2)}%`;
            
            updatePlatformSummary();
        }

        function calculateAPR(currentBalance, previousBalance, daysDiff, useCompound = false) {
            if (!previousBalance || previousBalance === 0 || daysDiff <= 0) return 0;
            
            if (useCompound) {
                const growthRate = currentBalance / previousBalance;
                if (growthRate <= 0) return 0;
                const annualizedGrowthRate = Math.pow(growthRate, 365 / daysDiff);
                return (annualizedGrowthRate - 1) * 100;
            } else {
                const growth = (currentBalance - previousBalance) / previousBalance;
                const annualizedGrowth = growth * (365 / daysDiff);
                return annualizedGrowth * 100;
            }
        }

        function calculateAdjustedBalances() {
            const latestDate = filteredEntries.reduce((max, e) => e.date > max ? e.date : max, '');
            const latestEntries = latestDate ? filteredEntries.filter(e => e.date === latestDate) : [];
            const totalBalance = latestEntries.reduce((sum, e) => sum + e.balance, 0);
            
            const totalDeposits = filteredCashflows.filter(c => c.type === 'deposit').reduce((sum, c) => sum + c.amount, 0);
            const totalWithdrawals = filteredCashflows.filter(c => c.type === 'withdraw').reduce((sum, c) => sum + c.amount, 0);
            const netInvested = totalDeposits - totalWithdrawals;
            
            return {
                totalBalance,
                totalDeposits,
                totalWithdrawals,
                netInvested
            };
        }

        function updatePlatformSummary() {
            const tbody = document.getElementById('platformSummaryBody');
            if (!tbody) return;
            
            const hideZeroBalance = document.getElementById('hideZeroBalance')?.checked || false;
            const platformData = filteredEntries.reduce((acc, entry) => {
                if (!acc[entry.protocol]) acc[entry.protocol] = [];
                acc[entry.protocol].push(entry);
                return acc;
            }, {});

            if (Object.keys(platformData).length === 0) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">📊</div><div>Keine Daten</div></div></td></tr>`;
                return;
            }
            
            let summaryData = [];
            Object.keys(platformData).forEach(platform => {
                const pEntries = platformData[platform].sort((a, b) => new Date(a.date) - new Date(b.date));
                const current = pEntries[pEntries.length - 1];
                const previous = pEntries.length > 1 ? pEntries[pEntries.length - 2] : null;
                
                if (hideZeroBalance && current.balance === 0) return;
                
                let weeklyChange = 0, weeklyChangePercent = 0, apr = 0;
                
                if (previous) {
                    weeklyChange = current.balance - previous.balance;
                    if (previous.balance !== 0) {
                       weeklyChangePercent = (weeklyChange / previous.balance * 100);
                       const daysDiff = (new Date(current.date) - new Date(previous.date)) / (1000 * 60 * 60 * 24);
                       apr = calculateAPR(current.balance, previous.balance, daysDiff, useCompoundAPR);
                    }
                }

                summaryData.push({
                    platform: platform,
                    balance: current.balance,
                    change: weeklyChange,
                    changePercent: weeklyChangePercent,
                    week: weeklyChangePercent,
                    apr: apr,
                    note: current.note || ''
                });
            });

            summaryData.sort((a, b) => {
                const valA = a[summarySort.key];
                const valB = b[summarySort.key];
                const order = summarySort.order === 'asc' ? 1 : -1;
                if (typeof valA === 'string') {
                    return valA.localeCompare(valB) * order;
                }
                return (valA - valB) * order;
            });
            
            tbody.innerHTML = '';

            summaryData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600;">${data.platform}</td>
                    <td>${data.balance === 0 ? '-' : data.balance.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="${data.change >= 0 ? 'positive' : 'negative'}">
                        ${data.change !== 0 ? (data.change >= 0 ? '+' : '') + Math.abs(data.change).toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-'}
                    </td>
                    <td class="${data.week >= 0 ? 'positive' : 'negative'}">
                        ${data.week !== 0 ? (data.week >= 0 ? '+' : '') + data.week.toFixed(1) + '%' : '-'}
                    </td>
                    <td><span class="apr-badge ${data.apr > 50 ? 'apr-high' : data.apr > 20 ? 'apr-medium' : 'apr-low'}">${data.apr.toFixed(1)}%</span></td>
                    <td>${data.note}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateHistory(searchTerm = '') {
            const tbody = document.getElementById('historyTableBody');
            if (!tbody) return;
            
            let historyEntries = [...filteredEntries];
            
            if (searchTerm) {
                historyEntries = historyEntries.filter(e => 
                    e.protocol.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    e.date.includes(searchTerm) ||
                    (e.note && e.note.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            }
            
            const sortedEntries = historyEntries.sort((a, b) => {
                const valA = a[historySort.key];
                const valB = b[historySort.key];
                const order = historySort.order === 'asc' ? 1 : -1;
                if(historySort.key === 'date') {
                    return (new Date(valA) - new Date(valB)) * order;
                }
                if (typeof valA === 'string') {
                    return valA.localeCompare(valB) * order;
                }
                return (valA - valB) * order;
            });

            if (sortedEntries.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><div class="empty-state-icon">📜</div><div>Keine Historie</div></div></td></tr>`;
                return;
            }
            
            tbody.innerHTML = '';
            
            sortedEntries.forEach((entry) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600;">${data.platform}</td>
                    <td>${data.balance === 0 ? '-' : data.balance.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="${data.change >= 0 ? 'positive' : 'negative'}">
                        ${data.change !== 0 ? (data.change >= 0 ? '+' : '') + Math.abs(data.change).toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-'}
                    </td>
                    <td class="${data.week >= 0 ? 'positive' : 'negative'}">
                        ${data.week !== 0 ? (data.week >= 0 ? '+' : '') + data.week.toFixed(1) + '%' : '-'}
                    </td>
                    <td><span class="apr-badge ${data.apr > 50 ? 'apr-high' : data.apr > 20 ? 'apr-medium' : 'apr-low'}">${data.apr.toFixed(1)}%</span></td>
                    <td>${data.note}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateCashflowDisplay() {
            const data = calculateAdjustedBalances();
            document.getElementById('totalDeposits').textContent = `${data.totalDeposits.toLocaleString('de-DE', {minimumFractionDigits: 2})}`;
            document.getElementById('totalWithdrawals').textContent = `${data.totalWithdrawals.toLocaleString('de-DE', {minimumFractionDigits: 2})}`;
            document.getElementById('netCashflow').textContent = `${data.netInvested.toLocaleString('de-DE', {minimumFractionDigits: 2})}`;
            
            const roi = data.netInvested !== 0 ? ((data.totalBalance - data.netInvested) / data.netInvested * 100) : 0;
            document.getElementById('roiPercent').textContent = `${roi.toFixed(2)}%`;
            
            const tbody = document.getElementById('cashflowTableBody');
            if (!tbody) return;
            
            const sortedCashflows = [...filteredCashflows].sort((a, b) => {
                const valA = a[cashflowSort.key];
                const valB = b[cashflowSort.key];
                const order = cashflowSort.order === 'asc' ? 1 : -1;
                if(cashflowSort.key === 'date') {
                    return (new Date(valA) - new Date(valB)) * order;
                }
                if (typeof valA === 'string') {
                    return valA.localeCompare(valB) * order;
                }
                return (valA - valB) * order;
            });

            if (sortedCashflows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">💸</div><div>Keine Cashflows</div></div></td></tr>`;
                return;
            }
            
            tbody.innerHTML = '';
            
            sortedCashflows.forEach((cf) => {
                const row = document.createElement('tr');
                const typeLabel = cf.type === 'deposit' ? 'Einzahlung' : 'Auszahlung';
                const typeClass = cf.type === 'deposit' ? 'type-deposit' : 'type-withdraw';
                
                row.innerHTML = `
                    <td>${formatDate(cf.date)}</td>
                    <td><span class="type-badge ${typeClass}">${typeLabel}</span></td>
                    <td class="${cf.type === 'deposit' ? 'positive' : 'negative'}">
                        ${cf.type === 'deposit' ? '+' : '-'}${cf.amount.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </td>
                    <td>${cf.platform || '-'}</td>
                    <td>${cf.note || '-'}</td>
                    <td><button class="btn btn-danger btn-small" onclick="deleteCashflow(${cf.id})">Löschen</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateCashflowTargets() {
            const select = document.getElementById('cashflowTarget');
            if (!select) return;
            
            select.innerHTML = '<option value="">Portfolio (Allgemein)</option>';
            platforms.forEach(p => {
                select.innerHTML += `<option value="${p.name}">${p.name}</option>`;
            });
        }

        function updatePlatformDetails() {
            const tbody = document.getElementById('platformDetailsBody');
            if (!tbody) return;
            
            const platformData = filteredEntries.reduce((acc, entry) => {
                if (!acc[entry.protocol]) {
                    acc[entry.protocol] = {
                        entries: [],
                        total: 0,
                        count: 0
                    };
                }
                acc[entry.protocol].entries.push(entry);
                acc[entry.protocol].total += entry.balance;
                acc[entry.protocol].count++;
                return acc;
            }, {});

            if (Object.keys(platformData).length === 0) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">💼</div><div>Keine Plattformen</div></div></td></tr>`;
                return;
            }

            let detailsData = [];
            Object.keys(platformData).forEach(platform => {
                const data = platformData[platform];
                const sorted = data.entries.sort((a, b) => new Date(a.date) - new Date(b.date));
                const first = sorted[0];
                const last = sorted[sorted.length - 1];
                const avg = data.total / data.count;
                const totalReturn = last.balance - first.balance;

                detailsData.push({
                    platform: platform,
                    entries: data.count,
                    first: first.date,
                    last: last.date,
                    avg: avg,
                    total: totalReturn
                });
            });

            detailsData.sort((a, b) => {
                const valA = a[platformDetailsSort.key];
                const valB = b[platformDetailsSort.key];
                const order = platformDetailsSort.order === 'asc' ? 1 : -1;
                if (typeof valA === 'string') {
                    return valA.localeCompare(valB) * order;
                }
                return (valA - valB) * order;
            });

            tbody.innerHTML = '';
            detailsData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600;">${data.platform}</td>
                    <td>${data.entries}</td>
                    <td>${formatDate(data.first)}</td>
                    <td>${formatDate(data.last)}</td>
                    <td>${data.avg.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="${data.total >= 0 ? 'positive' : 'negative'}">
                        ${data.total >= 0 ? '+' : ''}${data.total.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editEntry(cell, entryId) {
            const entry = entries.find(e => e.id == entryId);
            if (!entry) return;

            const originalValue = entry.balance;
            cell.onclick = null;
            cell.innerHTML = `<input type="text" inputmode="decimal" class="input-field" style="width: 120px; padding: 4px 8px;" value="${originalValue.toString().replace('.',',')}">`;
            
            const input = cell.querySelector('input');
            input.focus();
            input.select();

            const save = () => {
                const newValueRaw = input.value.replace(',', '.');
                const newValue = parseFloat(newValueRaw);
                if (!isNaN(newValue) && newValue !== originalValue) {
                    updateEntry(entryId, newValue);
                    showNotification('Balance aktualisiert!');
                } else {
                    cell.innerHTML = `${originalValue.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    cell.onclick = () => editEntry(cell, entryId);
                }
            };

            input.addEventListener('blur', save);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') save();
                else if (e.key === 'Escape') {
                    cell.innerHTML = `${originalValue.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    cell.onclick = () => editEntry(cell, entryId);
                }
            });
        }

        function editNote(cell, entryId) {
            const entry = entries.find(e => e.id == entryId);
            if (!entry) return;

            const originalNote = entry.note || '';
            cell.onclick = null;
            cell.innerHTML = `<input type="text" class="input-field" style="width: 100%; padding: 4px 8px;" value="${originalNote}">`;
            
            const input = cell.querySelector('input');
            input.focus();
            input.select();

            const save = () => {
                const newNote = input.value;
                updateEntryNote(entryId, newNote);
                cell.innerHTML = newNote || 'Klick zum Hinzufügen';
                cell.onclick = () => editNote(cell, entryId);
            };

            input.addEventListener('blur', save);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') save();
                else if (e.key === 'Escape') {
                    cell.innerHTML = originalNote || 'Klick zum Hinzufügen';
                    cell.onclick = () => editNote(cell, entryId);
                }
            });
        }

        function updateEntry(entryId, newBalance) {
            const entry = entries.find(e => e.id == entryId);
            if (entry) {
                entry.balance = newBalance;
                saveData();
                applyDateFilter();
                updateDisplay();
            }
        }

        function updateEntryNote(entryId, newNote) {
            const entry = entries.find(e => e.id == entryId);
            if (entry) {
                entry.note = newNote;
                saveData();
                showNotification('Notiz aktualisiert!');
            }
        }

        // CHARTS
        function initializeCharts() {
            const textColor = currentTheme === 'dark' ? '#f9fafb' : '#1f2937';
            const gridColor = currentTheme === 'dark' ? '#374151' : '#e5e7eb';

            const ctx1 = document.getElementById('portfolioChart')?.getContext('2d');
            if (ctx1) {
                portfolioChart = new Chart(ctx1, {
                    type: 'line',
                    data: { 
                        labels: [], 
                        datasets: [{ 
                            label: 'Portfolio Wert', 
                            data: [], 
                            backgroundColor: 'rgba(99, 102, 241, 0.2)', 
                            borderColor: 'rgba(99, 102, 241, 1)', 
                            borderWidth: 3, 
                            tension: 0.4, 
                            fill: true 
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { 
                            y: { 
                                beginAtZero: false, 
                                ticks: { 
                                    callback: (value) => '$' + value.toLocaleString('de-DE'), // KORRIGIERT
                                    color: textColor
                                },
                                grid: { color: gridColor }
                            },
                            x: {
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            }
                        }, 
                        plugins: { 
                            legend: { display: false }
                        } 
                    }
                });
            }

            const ctx2 = document.getElementById('allocationChart')?.getContext('2d');
            if (ctx2) {
                allocationChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: { 
                        labels: [], 
                        datasets: [{ 
                            data: [], 
                            backgroundColor: [
                                '#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe', 
                                '#e0e7ff', '#34d399', '#6ee7b7', '#a7f3d0',
                                '#fbbf24', '#fb923c', '#f87171', '#fb7185'
                            ] 
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { 
                                position: 'right',
                                labels: { color: textColor }
                            }
                        } 
                    }
                });
            }
        }

        function updateCharts() {
            updatePortfolioChart();
            updateAllocationChart();
        }

        function updatePortfolioChart() {
            if (!portfolioChart) return;
            
            const dateGroups = filteredEntries.reduce((acc, entry) => {
                acc[entry.date] = (acc[entry.date] || 0) + entry.balance;
                return acc;
            }, {});

            const sortedDates = Object.keys(dateGroups).sort((a, b) => new Date(a) - new Date(b));
            
            const labels = sortedDates.map(date => formatDate(date));
            const data = sortedDates.map(date => dateGroups[date]);
            
            portfolioChart.data.labels = labels;
            portfolioChart.data.datasets[0].data = data;
            portfolioChart.update();
        }

        function updateAllocationChart() {
            if (!allocationChart) return;

            const latestDate = filteredEntries.reduce((max, p) => p.date > max ? p.date : max, filteredEntries[0]?.date || '');
            if (!latestDate) {
                allocationChart.data.labels = [];
                allocationChart.data.datasets[0].data = [];
                allocationChart.update();
                return;
            }
            
            const latestEntries = filteredEntries.filter(e => e.date === latestDate);
            
            const labels = latestEntries.map(e => e.protocol);
            const data = latestEntries.map(e => e.balance);

            allocationChart.data.labels = labels;
            allocationChart.data.datasets[0].data = data;
            allocationChart.update();
        }

        function updateChartRange() {
            const range = document.getElementById('chartRange')?.value;
            if (!range || !portfolioChart) return;

            const dateGroups = filteredEntries.reduce((acc, entry) => {
                acc[entry.date] = (acc[entry.date] || 0) + entry.balance;
                return acc;
            }, {});

            let sortedDates = Object.keys(dateGroups).sort((a, b) => new Date(a) - new Date(b));
            
            if (range !== 'all') {
                const days = parseInt(range);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                sortedDates = sortedDates.filter(date => new Date(date) >= cutoffDate);
            }

            const labels = sortedDates.map(date => formatDate(date));
            const data = sortedDates.map(date => dateGroups[date]);

            portfolioChart.data.labels = labels;
            portfolioChart.data.datasets[0].data = data;
            portfolioChart.update();
        }

        function downloadChart() {
            const canvas = document.getElementById('portfolioChart');
            if (!canvas) return;
            
            const imageURL = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = imageURL;
            a.download = `portfolio-chart_${new Date().toISOString().split('T')[0]}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // CSV HANDLING
        function exportData() {
            if (entries.length === 0 && cashflows.length === 0) {
                showNotification('Keine Daten vorhanden!', 'error');
                return;
            }
            
            let csv = 'Typ,Datum,Plattform,Betrag,Notiz\n';
            
            const sortedEntries = [...entries].sort((a,b) => new Date(a.date) - new Date(b.date));
            sortedEntries.forEach(entry => {
                csv += `Balance,${entry.date},"${entry.protocol}",${entry.balance},"${entry.note || ''}"\n`;
            });
            
            const sortedCashflows = [...cashflows].sort((a,b) => new Date(a.date) - new Date(b.date));
            sortedCashflows.forEach(cf => {
                csv += `${cf.type === 'deposit' ? 'Einzahlung' : 'Auszahlung'},${cf.date},"${cf.platform}",${cf.amount},"${cf.note || ''}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function handleCsvImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                parseCSV(e.target.result);
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function parseCSV(csvText) {
            const lines = csvText.split(/\r\n|\n/);
            let addedEntries = 0;
            let addedCashflows = 0;

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const values = line.split(',');
                if (values.length < 4) continue;

                const type = values[0].trim().toLowerCase();
                const date = values[1].trim();
                const platform = values[2].trim().replace(/"/g, '');
                const amount = parseFloat(values[3].trim().replace(',', '.'));
                const note = values[4] ? values[4].trim().replace(/"/g, '') : '';

                if (date && !isNaN(amount)) {
                    if (type === 'balance') {
                        const existingEntryIndex = entries.findIndex(e => e.date === date && e.protocol === platform);
                        if (existingEntryIndex === -1) {
                            entries.push({ 
                                id: Date.now() + Math.random(), 
                                date, 
                                protocol: platform, 
                                balance: amount,
                                note 
                            });
                            addedEntries++;
                        }
                    } else if (type === 'einzahlung' || type === 'deposit') {
                        cashflows.push({
                            id: Date.now() + Math.random(),
                            type: 'deposit',
                            amount: amount,
                            date: date,
                            platform: platform || 'Portfolio',
                            note: note
                        });
                        addedCashflows++;
                    } else if (type === 'auszahlung' || type === 'withdraw') {
                        cashflows.push({
                            id: Date.now() + Math.random(),
                            type: 'withdraw',
                            amount: amount,
                            date: date,
                            platform: 'Portfolio',
                            note: note
                        });
                        addedCashflows++;
                    }
                }
            }

            if (addedEntries > 0 || addedCashflows > 0) {
                saveData();
                applyDateFilter();
                updateDisplay();
                showNotification(`${addedEntries} Einträge und ${addedCashflows} Cashflows hinzugefügt!`);
            } else {
                showNotification('Keine neuen Daten gefunden!', 'error');
            }
        }

        // PDF EXPORT
        function exportPDF() {
            const data = calculateAdjustedBalances();
            
            // Create HTML report as fallback
            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Portfolio Report</title>
                    <style>
                        body { font-family: Arial; padding: 20px; }
                        h1 { color: #6366f1; }
                        h2 { color: #4f46e5; margin-top: 30px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background: #f0f0f0; }
                        .positive { color: #10b981; }
                        .negative { color: #ef4444; }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Web3 Portfolio Report</h1>
                    <p>Datum: ${new Date().toLocaleDateString('de-DE')}</p>
                    
                    <h2>Portfolio Übersicht</h2>
                    <p><strong>Gesamtwert:</strong> ${data.totalBalance.toLocaleString('de-DE', {minimumFractionDigits: 2})}</p>
                    <p><strong>Netto Investiert:</strong> ${data.netInvested.toLocaleString('de-DE', {minimumFractionDigits: 2})}</p>
                    <p><strong>Profit:</strong> ${(data.totalBalance - data.netInvested).toLocaleString('de-DE', {minimumFractionDigits: 2})}</p>
                    <p><strong>ROI:</strong> ${data.netInvested !== 0 ? ((data.totalBalance - data.netInvested) / data.netInvested * 100).toFixed(2) : 0}%</p>
                    
                    <h2>Platform Performance</h2>
                    <table>
                        <tr>
                            <th>Plattform</th>
                            <th>Balance</th>
                            <th>Letzte Änderung</th>
                        </tr>`;
            
            const platformData = filteredEntries.reduce((acc, entry) => {
                if (!acc[entry.protocol]) acc[entry.protocol] = [];
                acc[entry.protocol].push(entry);
                return acc;
            }, {});
            
            Object.keys(platformData).forEach(platform => {
                const pEntries = platformData[platform].sort((a, b) => new Date(a.date) - new Date(b.date));
                const current = pEntries[pEntries.length - 1];
                const previous = pEntries.length > 1 ? pEntries[pEntries.length - 2] : null;
                const change = previous ? current.balance - previous.balance : 0;
                
                html += `
                    <tr>
                        <td>${platform}</td>
                        <td>${current.balance.toLocaleString('de-DE', {minimumFractionDigits: 2})}</td>
                        <td class="${change >= 0 ? 'positive' : 'negative'}">
                            ${change >= 0 ? '+' : ''}${Math.abs(change).toLocaleString('de-DE', {minimumFractionDigits: 2})}
                        </td>
                    </tr>`;
            });
            
            html += `
                    </table>
                </body>
                </html>`;
            
            const blob = new Blob([html], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio-report_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Report als HTML exportiert (öffnen zum Drucken)');
        }

        // HELPER FUNCTIONS
        function setToToday() {
            const today = new Date();
            document.getElementById('entryDate').value = today.toISOString().split('T')[0];
        }

        function setToYesterday() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('entryDate').value = yesterday.toISOString().split('T')[0];
        }

        function setToLastSunday() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysFromLastSunday = dayOfWeek === 0 ? 7 : dayOfWeek;
            const lastSunday = new Date(today);
            lastSunday.setDate(today.getDate() - daysFromLastSunday);
            document.getElementById('entryDate').value = lastSunday.toISOString().split('T')[0];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('de-DE', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
        }

        function getLastEntryForPlatform(platformName) {
            const platformEntries = entries.filter(e => e.protocol === platformName);
            return platformEntries.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        }

        function showNotification(text, type = 'success') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const textElement = document.getElementById('notificationText');
            
            if (type === 'error') {
                notification.classList.add('error');
                icon.textContent = '❌';
            } else {
                notification.classList.remove('error');
                icon.textContent = '✅';
            }
            
            textElement.textContent = text;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function setupPromptModal() {
            const modal = document.getElementById('promptModal');
            const okButton = document.getElementById('promptModalOk');
            const cancelButton = document.getElementById('promptModalCancel');
            const input = document.getElementById('promptModalInput');

            const close = (value) => {
                modal.classList.remove('visible');
                if (promptResolve) {
                    promptResolve(value);
                    promptResolve = null;
                }
            };

            okButton.onclick = () => close(input.style.display === 'none' ? true : input.value);
            cancelButton.onclick = () => close(null);
            
            modal.onclick = (e) => {
                if (e.target === modal) close(null);
            };

            input.onkeydown = (e) => {
                if (e.key === 'Enter') okButton.click();
                else if (e.key === 'Escape') cancelButton.click();
            };
        }

        function showCustomPrompt({ title, text, showInput = true, hideCancel = false }) {
            return new Promise(resolve => {
                promptResolve = resolve;
                
                document.getElementById('promptModalTitle').textContent = title;
                document.getElementById('promptModalText').textContent = text;
                const modalInput = document.getElementById('promptModalInput');
                const cancelButton = document.getElementById('promptModalCancel');
                
                modalInput.style.display = showInput ? 'block' : 'none';
                cancelButton.style.display = hideCancel ? 'none' : 'inline-flex';
                
                if (showInput) modalInput.value = '';
                
                document.getElementById('promptModal').classList.add('visible');
                if (showInput) modalInput.focus();
            });
        }

        function handleSort(e) {
            const th = e.currentTarget;
            const table = th.closest('table');
            const sortKey = th.dataset.sort;
            
            if (table.querySelector('#historyTableBody')) {
                if (historySort.key === sortKey) {
                    historySort.order = historySort.order === 'asc' ? 'desc' : 'asc';
                } else {
                    historySort.key = sortKey;
                    historySort.order = 'desc';
                }
                updateHistory();
            } else if (table.querySelector('#platformSummaryBody')) {
                if (summarySort.key === sortKey) {
                    summarySort.order = summarySort.order === 'asc' ? 'desc' : 'asc';
                } else {
                    summarySort.key = sortKey;
                    summarySort.order = 'desc';
                }
                updatePlatformSummary();
            } else if (table.querySelector('#platformDetailsBody')) {
                if (platformDetailsSort.key === sortKey) {
                    platformDetailsSort.order = platformDetailsSort.order === 'asc' ? 'desc' : 'asc';
                } else {
                    platformDetailsSort.key = sortKey;
                    platformDetailsSort.order = 'asc';
                }
                updatePlatformDetails();
            } else if (table.querySelector('#cashflowTableBody')) {
                if (cashflowSort.key === sortKey) {
                    cashflowSort.order = cashflowSort.order === 'asc' ? 'desc' : 'asc';
                } else {
                    cashflowSort.key = sortKey;
                    cashflowSort.order = 'desc';
                }
                updateCashflowDisplay();
            }
        }

        // Update sync time display every minute
        setInterval(updateLastSyncDisplay, 60000);
    </script>
</body>
</html>
